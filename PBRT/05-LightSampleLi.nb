(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     49920,       1291]
NotebookOptionsPosition[     49395,       1274]
NotebookOutlinePosition[     49738,       1289]
CellTagsIndexPosition[     49695,       1286]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"SetDirectory", "[", 
   RowBox[{"FileNameJoin", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ParentDirectory", "[", 
       RowBox[{"NotebookDirectory", "[", "]"}], "]"}], ",", 
      "\"\<Shared\>\""}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Needs", "[", "\"\<gPlots3DEx`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Needs", "[", "\"\<gPlotsEx`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Needs", "[", "\"\<gBRDF`\>\"", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Needs", "[", "\"\<gUtils`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SetDirectory", "[", 
    RowBox[{"NotebookDirectory", "[", "]"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", 
    RowBox[{
    "scene", ",", "camera", ",", "eyePt", ",", "lookPt", ",", "upDir", ",", 
     "fov", ",", "lights", ",", "prims", ",", "\[IndentingNewLine]", 
     "camBoundMin", ",", "camBoundMax", ",", "rasterToCam", ",", 
     "xformRasterToCamera", ",", "\[IndentingNewLine]", "gGetCameraSample", 
     ",", "get1D", ",", "get2D", ",", "\[IndentingNewLine]", "rayMaxDist", 
     ",", "camRayo", ",", "camRayd", ",", "calcTriNormal", ",", 
     "triIntersect", ",", "sceneIntersect", ",", "\[IndentingNewLine]", 
     "isect", ",", "getUVs", ",", "bsdf", ",", "computeScatteringFunctions", 
     ",", "uniformSampleOneLight", ",", "\[IndentingNewLine]", "li", ",", 
     "ld", ",", "beta", ",", "estimateDirect", ",", "lightSampleLi", ",", 
     "triSample", ",", "uniformSampleTri", ",", "\[IndentingNewLine]", 
     "shapeSample", ",", "triArea", ",", "lightL", ",", "\[IndentingNewLine]",
      "imgSettings", ",", "resx", ",", "resy", ",", "graphList", ",", 
     "createPolyGraphs", ",", "imgTable", ",", "\[IndentingNewLine]", 
     "resultFlag", ",", "testRender"}], "]"}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"get", " ", "sampling", " ", "data", " ", "by", " ", "x"}], ",", 
    RowBox[{"y", " ", "and", " ", "dimension"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"gGetCameraSample", "[", 
     RowBox[{"x_", ",", "y_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"dim", ",", "startIdx", ",", "sampValue", ",", "data"}], "}"}],
       ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"dim", "=", "2"}], ";", "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"sampValue", "=", "0.5"}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"For", "[", 
          RowBox[{
           RowBox[{"i", "=", "0"}], ",", 
           RowBox[{"i", "<", "dim"}], ",", 
           RowBox[{"i", "++"}], ",", 
           RowBox[{"AppendTo", "[", 
            RowBox[{"data", ",", 
             RowBox[{"dataArray", "[", 
              RowBox[{"[", 
               RowBox[{"startIdx", "+", "i"}], "]"}], "]"}]}], "]"}]}], "]"}],
          ";"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"x", "+", "sampValue"}], ",", 
          RowBox[{"y", "+", "sampValue"}]}], "}"}]}], ";", 
       "\[IndentingNewLine]", "data"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"load", " ", "scene", " ", "data"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"scene", "=", 
   RowBox[{"ToExpression", "[", 
    RowBox[{"Import", "[", "\"\<cornell-tiny.scene\>\"", "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"camera", "=", 
   RowBox[{
    RowBox[{"scene", "[", "\"\<camera\>\"", "]"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"eyePt", "=", 
   RowBox[{"camera", "[", "\"\<eyePt\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"lookPt", "=", 
   RowBox[{"camera", "[", "\"\<lookPt\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"upDir", "=", 
   RowBox[{"camera", "[", "\"\<upDir\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"camera", "[", "\"\<fov\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{
    FractionBox["fov", "180"], "\[Pi]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"camBoundMin", "=", 
   RowBox[{"camera", "[", "\"\<boundMin\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"camBoundMax", "=", 
   RowBox[{"camera", "[", "\"\<boundMax\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"rasterToCam", "=", 
   RowBox[{"camera", "[", "\"\<rasterToCam\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"lights", "=", 
   RowBox[{"scene", "[", "\"\<lights\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"prims", "=", 
   RowBox[{"scene", "[", "\"\<prims\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"imgSettings", "=", 
   RowBox[{
    RowBox[{"scene", "[", "\"\<image\>\"", "]"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"resx", "=", 
   RowBox[{"imgSettings", "[", "\"\<resx\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"resy", "=", 
   RowBox[{"imgSettings", "[", "\"\<resy\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Assert", "[", 
    RowBox[{
     RowBox[{"resx", ">", "0"}], "&&", 
     RowBox[{"resy", ">", "0"}]}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"get1D", "[", "]"}], ":=", "0.5"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"get2D", "[", "]"}], ":=", 
    RowBox[{"{", 
     RowBox[{"0.5", ",", "0.5"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "transform", " ", "raster", " ", "point", " ", "to", " ", "world", " ", 
    "point"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"xformRasterToCamera", "[", "rasterPt_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "worldPt", ",", "m", ",", "x", ",", "y", ",", "z", ",", "xp", ",", 
        "yp", ",", "zp", ",", "wp", ",", "dirRHS"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"m", "=", "rasterToCam"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"x", "=", 
        RowBox[{"rasterPt", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"y", "=", 
        RowBox[{"rasterPt", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"z", "=", "0"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", "  ", 
       RowBox[{"xp", "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "x"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "y"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", "z"}], "+", 
         RowBox[{
          RowBox[{"m", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "[", 
          RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\n", "\t", 
       RowBox[{"yp", "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "x"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "y"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", "z"}], "+", 
         RowBox[{
          RowBox[{"m", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "[", 
          RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\n", "\t", 
       RowBox[{"zp", "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "3", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "x"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "3", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "y"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "3", "]"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", "z"}], "+", 
         RowBox[{
          RowBox[{"m", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "[", 
          RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\n", "\t", 
       RowBox[{"wp", "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "4", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "x"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "4", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "y"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "4", "]"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", "z"}], "+", 
         RowBox[{
          RowBox[{"m", "[", 
           RowBox[{"[", "4", "]"}], "]"}], "[", 
          RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"dirRHS", "=", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"xp", ",", "zp", ",", "yp"}], "}"}], "/", "wp"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Normalize", "@", "dirRHS"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"generate", " ", "ray"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"generateRayDifferential", "[", "pixel_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"px", ",", "py", ",", "sampRasterPt", ",", "sampDir"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"px", "=", 
        RowBox[{"pixel", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"py", "=", 
        RowBox[{"pixel", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"sampRasterPt", "=", 
        RowBox[{"gGetCameraSample", "[", 
         RowBox[{"px", ",", "py"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"sampDir", "=", 
        RowBox[{"xformRasterToCamera", "[", "sampRasterPt", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Normalize", "@", "sampDir"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"getUVs", "[", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "1"}], "}"}]}], "}"}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Triangle", "::", "Intersect"}], " ", "cross", " ", "op", " ", 
    "is", " ", "changed", " ", "to", " ", "RHS"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"calcTriNormal", "[", "tri_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "dp02", ",", "dp12", ",", "n", ",", "uv", ",", "duv02", ",", "duv12", 
        ",", "determinant", ",", "degenerateUV", ",", "invdet", ",", 
        "\[IndentingNewLine]", "\t", "dpdu", ",", "dpdv"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"dp02", "=", 
        RowBox[{
         RowBox[{"tri", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "-", 
         RowBox[{"tri", "[", 
          RowBox[{"[", "3", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"dp12", "=", 
        RowBox[{
         RowBox[{"tri", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"tri", "[", 
          RowBox[{"[", "3", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", "=", 
        RowBox[{"Normalize", "@", 
         RowBox[{"Cross", "[", 
          RowBox[{"dp12", ",", "dp02"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"calculate", " ", "dpdu"}], ",", " ", "dpdv"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"uv", "=", 
        RowBox[{"getUVs", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"duv02", "=", 
        RowBox[{
         RowBox[{"uv", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "-", 
         RowBox[{"uv", "[", 
          RowBox[{"[", "3", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"duv12", "=", 
        RowBox[{
         RowBox[{"uv", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"uv", "[", 
          RowBox[{"[", "3", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"determinant", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"duv02", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", 
          RowBox[{"duv12", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "-", 
         RowBox[{
          RowBox[{"duv02", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", 
          RowBox[{"duv12", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"degenerateUV", "=", 
        RowBox[{"determinant", "<", "0.000001"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", 
        RowBox[{"(", 
         RowBox[{"!", "degenerateUV"}], ")"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"invdet", "=", 
        RowBox[{"1", "/", "determinant"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"dpdu", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"duv12", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "*", "dp02"}], "-", 
           RowBox[{
            RowBox[{"duv02", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "*", "dp12"}]}], ")"}], "*", 
         "invdet"}]}], ";", "\n", "\t", 
       RowBox[{"dpdv", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"-", 
             RowBox[{"duv12", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "*", "dp02"}], "+", 
           RowBox[{
            RowBox[{"duv02", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "*", "dp12"}]}], ")"}], "*", 
         "invdet"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"n", ",", "dpdu", ",", "dpdv"}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rayMaxDist", "=", "10000"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Triangle", "::", "Intersect"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"triIntersect", "[", 
     RowBox[{"ray_", ",", "tri_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "rayo", ",", "rayd", ",", "R", ",", "L", ",", "d", ",", "curve", ",", 
        "t", ",", "pt"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"rayo", "=", 
        RowBox[{"ray", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rayd", "=", 
        RowBox[{"ray", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"R", "=", 
        RowBox[{"Triangle", "[", "tri", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"L", "=", 
        RowBox[{"Line", "[", 
         RowBox[{"{", 
          RowBox[{"rayo", ",", 
           RowBox[{"rayo", "+", 
            RowBox[{"rayd", "*", "rayMaxDist"}]}]}], "}"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"d", "=", 
        RowBox[{"RegionDistance", "[", "R", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"curve", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{"1", "-", "t"}], ")"}], " ", 
          RowBox[{"L", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}]}], "+", 
         RowBox[{"t", " ", 
          RowBox[{"L", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "2"}], "]"}], "]"}]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"pt", "=", 
        RowBox[{"Quiet", "@", 
         RowBox[{"Check", "[", 
          RowBox[{
           RowBox[{"curve", "/.", 
            RowBox[{"FindRoot", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"d", "[", "curve", "]"}], "\[Equal]", "0"}], ",", 
              RowBox[{"{", 
               RowBox[{"t", ",", "0", ",", "1"}], "}"}], ",", 
              RowBox[{"Method", "\[Rule]", "\"\<Secant\>\""}]}], "]"}]}], ",",
            "\[IndentingNewLine]", "\"\<NaN\>\"", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"FindRoot", "::", "lstol"}], ",", 
             RowBox[{"FindRoot", "::", "jsing"}], ",", 
             RowBox[{"FindRoot", "::", "cvmit"}]}], "}"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "pt"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Scene", "::", "Intersect"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"sceneIntersect", "[", "ray_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "rayo", ",", "rayd", ",", "prim", ",", "tri", ",", "dist", ",", 
        "triInts", ",", "minDist", ",", "minIntsPt", ",", 
        "\[IndentingNewLine]", "minPrim", ",", "minTri", ",", 
        "\[IndentingNewLine]", "minNormal", ",", "dpdu", ",", "dpdv", ",", 
        "material"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"rayo", "=", 
        RowBox[{"ray", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rayd", "=", 
        RowBox[{"ray", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"minDist", "=", "rayMaxDist"}], " ", ";", 
       "\[IndentingNewLine]", 
       RowBox[{"minPrim", "=", "\"\<NaN\>\""}], ";", "\[IndentingNewLine]", 
       RowBox[{"minTri", "=", "\"\<NaN\>\""}], ";", "\[IndentingNewLine]", 
       RowBox[{"minIntsPt", "=", "\"\<NaN\>\""}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", "1"}], ",", 
         RowBox[{"i", "\[LessEqual]", 
          RowBox[{"Length", "[", "prims", "]"}]}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"prim", "=", 
           RowBox[{"prims", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"tri", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"prim", ",", "\"\<tri\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"triInts", "=", 
           RowBox[{"triIntersect", "[", 
            RowBox[{"ray", ",", "tri"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"triInts", "\[Equal]", "\"\<NaN\>\""}], ",", 
            RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"Assert", "[", 
           RowBox[{
            RowBox[{"Length", "[", "triInts", "]"}], "\[Equal]", "3"}], "]"}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"dist", "=", 
           RowBox[{"Norm", "[", 
            RowBox[{"triInts", "-", "rayo"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"dist", "\[GreaterEqual]", "minDist"}], ",", 
            RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"minPrim", "=", "prim"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minDist", "=", "dist"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minTri", "=", "tri"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minIntsPt", "=", "triInts"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"minNormal", ",", "dpdu", ",", "dpdv"}], "}"}], "=", 
        RowBox[{"calcTriNormal", "[", "minTri", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"material", "=", 
        RowBox[{"gAssocData", "[", 
         RowBox[{"minPrim", ",", "\"\<material\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", "result", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{
         RowBox[{"\"\<p\>\"", "\[Rule]", "minIntsPt"}], ",", 
         RowBox[{"\"\<n\>\"", "\[Rule]", "minNormal"}], ",", 
         RowBox[{"\"\<wo\>\"", "\[Rule]", 
          RowBox[{"-", "rayd"}]}], ",", "\[IndentingNewLine]", "\t", 
         RowBox[{"\"\<dpdu\>\"", "\[Rule]", "dpdu"}], ",", 
         RowBox[{"\"\<dpdv\>\"", "\[Rule]", "dpdv"}], ",", 
         "\[IndentingNewLine]", "\t", 
         RowBox[{"\"\<tri\>\"", "\[Rule]", "minTri"}], ",", 
         RowBox[{"\"\<material\>\"", "\[Rule]", "material"}]}], "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"BSDF", "::", "BSDF"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"constructBSDF", "[", 
     RowBox[{"si_", ",", "eta_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"ns", ",", "ss", ",", "ts"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ns", "=", 
        RowBox[{"si", "[", "\"\<n\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ss", "=", 
        RowBox[{"Normalize", "@", 
         RowBox[{"si", "[", "\"\<dpdu\>\"", "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ts", "=", 
        RowBox[{"Cross", "[", 
         RowBox[{"ss", ",", "ns"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{
         RowBox[{"\"\<eta\>\"", "\[Rule]", "eta"}], ",", 
         RowBox[{"\"\<ns\>\"", "\[Rule]", "ns"}], ",", 
         RowBox[{"\"\<ng\>\"", "\[Rule]", 
          RowBox[{"si", "[", "\"\<n\>\"", "]"}]}], ",", 
         RowBox[{"\"\<ss\>\"", "\[Rule]", "ss"}], ",", 
         RowBox[{"\"\<ts\>\"", "\[Rule]", "ts"}]}], "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"geometry", " ", "plot", " ", "graph"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"graphList", "=", 
   RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"createPolyGraphs", "[", "elems_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "i", ",", "elem", ",", "tri", ",", "mat", ",", "Kd", ",", "sigma"}], 
       "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", "1"}], ",", 
         RowBox[{"i", "\[LessEqual]", 
          RowBox[{"Length", "[", "elems", "]"}]}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"elem", "=", 
           RowBox[{"elems", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"tri", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"elem", ",", "\"\<tri\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"mat", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"elem", ",", "\"\<material\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Kd", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"mat", ",", "\"\<Kd\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"sigma", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"mat", ",", "\"\<sigma\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"AppendTo", "[", 
           RowBox[{"graphList", ",", 
            RowBox[{"RGBColor", "[", "Kd", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"AppendTo", "[", 
           RowBox[{"graphList", ",", 
            RowBox[{"Polygon", "[", "tri", "]"}]}], "]"}]}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"createPolyGraphs", "[", "lights", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"createPolyGraphs", "[", "prims", "]"}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"creating", " ", "image", " ", "table"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"imgTable", "=", 
   RowBox[{"Table", "[", 
    RowBox[{"1", ",", "resx", ",", "resy"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"For", "[", 
    RowBox[{
     RowBox[{"i", "=", "1"}], ",", 
     RowBox[{"i", "\[LessEqual]", "resx"}], ",", 
     RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
     RowBox[{"For", "[", 
      RowBox[{
       RowBox[{"j", "=", "1"}], ",", 
       RowBox[{"j", "\[LessEqual]", "resy"}], ",", 
       RowBox[{"j", "++"}], ",", "\[IndentingNewLine]", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"imgTable", "[", 
           RowBox[{"[", "i", "]"}], "]"}], "[", 
          RowBox[{"[", "j", "]"}], "]"}], "=", 
         RowBox[{"RGBColor", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"i", "+", "j"}], ")"}], "*", "0.01"}], ",", "0", ",", 
           "0"}], "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
    "\[IndentingNewLine]", "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"testRender", ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", "1"}], ",", 
         RowBox[{"i", "\[LessEqual]", "resx"}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{"For", "[", 
          RowBox[{
           RowBox[{"j", "=", "1"}], ",", 
           RowBox[{"j", "\[LessEqual]", "resy"}], ",", 
           RowBox[{"j", "++"}], ",", "\[IndentingNewLine]", " ", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"imgTable", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}], "=", 
             RowBox[{"RGBColor", "[", 
              RowBox[{"0", ",", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"i", "+", "j"}], ")"}], "*", "0.01"}], ",", "0"}], 
              "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"resultFlag", "=", "False"}], ";", "\[IndentingNewLine]", 
    RowBox[{"Manipulate", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Show", "[", "\[IndentingNewLine]", "\t", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{"resultFlag", ",", 
          RowBox[{"ArrayPlot", "[", "imgTable", "]"}], ",", 
          RowBox[{"Graphics3D", "[", "graphList", "]"}]}], "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"Lighting", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"\"\<Ambient\>\"", ",", "White"}], "}"}], "}"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"Boxed", "\[Rule]", "False"}], ",", " ", 
        RowBox[{"Axes", "\[Rule]", "False"}], ",", 
        RowBox[{"AxesLabel", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"\"\<X\>\"", ",", "\"\<Y\>\"", ",", "\"\<Z\>\""}], "}"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"ViewVector", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{"eyePt", ",", "lookPt"}], "}"}]}], ",", 
        RowBox[{"ViewVertical", "\[Rule]", "upDir"}], ",", 
        RowBox[{"ViewAngle", "\[Rule]", "fov"}]}], "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Button", "[", 
       RowBox[{"\"\<Result\>\"", ",", 
        RowBox[{"resultFlag", "=", 
         RowBox[{"!", "resultFlag"}]}]}], "]"}], ",", "\[IndentingNewLine]", 
      RowBox[{"Button", "[", 
       RowBox[{"\"\<Start\>\"", ",", 
        RowBox[{"testRender", "[", "]"}]}], "]"}]}], "\[IndentingNewLine]", 
     "]"}]}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"MatteMaterial", "::", "ComputeScatteringFunctions"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"computeScatteringFunctions", "[", "si_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"bsdf", ",", "material", ",", "r", ",", "sig", ",", "newsi"}], 
       "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"bsdf", "=", 
        RowBox[{"constructBSDF", "[", 
         RowBox[{"si", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"material", "=", 
        RowBox[{"si", "[", "\"\<material\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"r", "=", 
        RowBox[{"material", "[", "\"\<Kd\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"sig", "=", 
        RowBox[{"material", "[", "\"\<sigma\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"sig", "=", 
        RowBox[{"Clip", "[", 
         RowBox[{"sig", ",", 
          RowBox[{"{", 
           RowBox[{"0", ",", "90"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"not", " ", "black"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"r", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "\[NotEqual]", "0"}], "||", 
         RowBox[{
          RowBox[{"r", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "\[NotEqual]", "0"}], "||", 
         RowBox[{
          RowBox[{"r", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "\[NotEqual]", "0"}]}], "]"}], ";",
        "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{"sig", "\[Equal]", "0"}], "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"bsdf", "[", "\"\<bxdfs0\>\"", "]"}], "=", 
        RowBox[{"<|", 
         RowBox[{
          RowBox[{"\"\<type\>\"", "\[Rule]", "\"\<LambertianReflection\>\""}],
           ",", 
          RowBox[{"\"\<R\>\"", "\[Rule]", "r"}]}], "|>"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"newsi", "=", "si"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"newsi", "[", "\"\<bsdf\>\"", "]"}], "=", "bsdf"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "newsi"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "UniformSampleTriangle", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"uniformSampleTri", "[", "u_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "su0", "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"su0", "=", 
        RowBox[{"Sqrt", "[", 
         RowBox[{"u", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"1", "-", "su0"}], ",", 
         RowBox[{
          RowBox[{"u", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "su0"}]}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Triangle", "::", "Area"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"triArea", "[", "tri_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"p0", ",", "p1", ",", "p2", ",", "area"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"p0", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p1", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p2", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"area", "=", 
        RowBox[{"0.5", "*", 
         RowBox[{"Norm", "@", 
          RowBox[{"Cross", "[", 
           RowBox[{
            RowBox[{"p2", "-", "p0"}], ",", 
            RowBox[{"p1", "-", "p0"}]}], "]"}]}]}]}], ";", 
       "\[IndentingNewLine]", "area"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Triangle", "::", "Sample"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"triSample", "[", 
     RowBox[{"tri_", ",", "u_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "b", ",", "p0", ",", "p1", ",", "p2", ",", "itP", ",", "itN", ",", 
        "itError", ",", "pAbsSum", ",", "gamma6", ",", "pdf"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"b", "=", 
        RowBox[{"uniformSampleTri", "[", "u", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"p0", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p1", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p2", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"itP", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"b", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "p0"}], "+", 
         RowBox[{
          RowBox[{"b", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "p1"}], "+", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"1", "-", 
            RowBox[{"b", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "-", 
            RowBox[{"b", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], ")"}], "*", "p2"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"itN", "=", 
        RowBox[{"Normalize", "@", 
         RowBox[{"Cross", "[", 
          RowBox[{
           RowBox[{"p2", "-", "p0"}], ",", 
           RowBox[{"p1", "-", "p0"}]}], "]"}]}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"pAbsSum", "=", 
        RowBox[{
         RowBox[{"Abs", "[", 
          RowBox[{
           RowBox[{"b", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "*", "p0"}], "]"}], "+", 
         RowBox[{"Abs", "[", 
          RowBox[{
           RowBox[{"b", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "*", "p1"}], "]"}], "+", 
         RowBox[{"Abs", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"1", "-", 
             RowBox[{"b", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "-", 
             RowBox[{"b", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ")"}], "*", "p2"}], "]"}]}]}],
        ";", "\[IndentingNewLine]", 
       RowBox[{"gamma6", "=", 
        RowBox[{"3.57628011", "*", 
         RowBox[{"10", "^", 
          RowBox[{"-", "7"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"itError", "=", 
        RowBox[{"gamma6", "*", "pAbsSum"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"pdf", "=", 
        RowBox[{"1", "/", 
         RowBox[{"triArea", "[", "tri", "]"}]}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{
         RowBox[{"\"\<p\>\"", "\[Rule]", "itP"}], ",", 
         RowBox[{"\"\<n\>\"", "\[Rule]", "itN"}], ",", 
         RowBox[{"\"\<error\>\"", "\[Rule]", "itError"}], ",", 
         RowBox[{"\"\<pdf\>\"", "\[Rule]", "pdf"}]}], "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Shape", "::", "Sample"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"shapeSample", "[", 
     RowBox[{"light_", ",", "si_", ",", "u_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tri", ",", " ", "intr", ",", "wi", ",", "distSquared", ",", "pdf"}], 
       "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"tri", "=", 
        RowBox[{"gAssocData", "[", 
         RowBox[{"light", ",", "\"\<tri\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"intr", "=", 
        RowBox[{"triSample", "[", 
         RowBox[{"tri", ",", "u"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"wi", "=", 
        RowBox[{
         RowBox[{"intr", "[", "\"\<p\>\"", "]"}], "-", 
         RowBox[{"si", "[", "\"\<p\>\"", "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{"Norm", "[", "wi", "]"}], ">", "0"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"wi", "=", 
        RowBox[{"Normalize", "@", "wi"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"page", " ", "838"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Convert", " ", "from", " ", "area", " ", "measure", " ", "to", " ", 
         "solid", " ", "angle", " ", 
         RowBox[{"measure", "."}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"https", ":"}], "//", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"computergraphics", ".", "stackexchange", ".", "com"}], 
             "/", "questions"}], "/", "8032"}], "/", "how"}], "-", "can", "-",
           "we", "-", "convert", "-", "a", "-", "probability", "-", "density",
           "-", "according", "-", "to", "-", "solid", "-", "angle", "-", "to",
           "-", "a", "-", "density", "-", "a"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"distSquared", "=", 
        RowBox[{
         RowBox[{"Norm", "[", 
          RowBox[{
           RowBox[{"intr", "[", "\"\<p\>\"", "]"}], "-", 
           RowBox[{"si", "[", "\"\<p\>\"", "]"}]}], "]"}], "^", "2"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"pdf", "=", 
        RowBox[{
         RowBox[{"intr", "[", "\"\<pdf\>\"", "]"}], "*", 
         RowBox[{"distSquared", "/", 
          RowBox[{"Abs", "@", 
           RowBox[{"Dot", "[", 
            RowBox[{
             RowBox[{"intr", "[", "\"\<n\>\"", "]"}], ",", 
             RowBox[{"-", "wi"}]}], "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"intr", "[", "\"\<pdf\>\"", "]"}], "=", "pdf"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "intr"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"DiffuseAreaLight", "::", "L"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"lightL", "[", 
     RowBox[{"intr_", ",", "w_", ",", "light_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "kd", "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"kd", "=", 
        RowBox[{
         RowBox[{"light", "[", "\"\<material\>\"", "]"}], "[", "\"\<Kd\>\"", 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Dot", "[", 
           RowBox[{
            RowBox[{"intr", "[", "\"\<n\>\"", "]"}], ",", "w"}], "]"}], ">", 
          "0"}], ",", "kd", ",", "0"}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"DiffuseAreaLight", "::", "Sample_Li"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"lightSampleLi", "[", 
     RowBox[{"light_", ",", "ref_", ",", "u_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"pShape", ",", "wi", ",", "vis", ",", "l"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"pShape", "=", 
        RowBox[{"shapeSample", "[", 
         RowBox[{"light", ",", "ref", ",", "u"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"wi", "=", 
        RowBox[{"Normalize", "[", 
         RowBox[{
          RowBox[{"pShape", "[", "\"\<p\>\"", "]"}], "-", 
          RowBox[{"ref", "[", "\"\<p\>\"", "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vis", "=", 
        RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"l", "=", 
        RowBox[{"lightL", "[", 
         RowBox[{"pShape", ",", 
          RowBox[{"-", "wi"}], ",", "light"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{
         RowBox[{"\"\<li\>\"", "\[Rule]", "l"}], ",", 
         RowBox[{"\"\<wi\>\"", "\[Rule]", "wi"}], ",", 
         RowBox[{"\"\<pdf\>\"", "\[Rule]", 
          RowBox[{"pShape", "[", "\"\<pdf\>\"", "]"}]}]}], "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "EstimateDirect", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"estimateDirect", "[", 
     RowBox[{
     "si_", ",", "uScattering_", ",", "light_", ",", "uLight_", ",", 
      "handleMedia_", ",", "specular_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"li", ",", "wi", ",", "lightPdf", ",", "vis", ",", "lightLi"}],
        "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Assert", "[", 
        RowBox[{"handleMedia", "\[Equal]", "False"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{"specular", "\[Equal]", "False"}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"lightLi", "=", 
        RowBox[{"lightSampleLi", "[", 
         RowBox[{"light", ",", "si", ",", "uLight"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "lightLi"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", "UniformSampleOneLight", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"uniformSampleOneLight", "[", "isect_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "lightIndex", ",", "light", ",", "lightPdf", ",", "uLight", ",", 
        "uScattering", ",", "li"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"lightIndex", "=", "1"}], ";", "\[IndentingNewLine]", 
       RowBox[{"lightPdf", "=", "1"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{"1", "\[LessEqual]", "lightIndex", "\[LessEqual]", 
         RowBox[{"Length", "[", "lights", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"light", "=", 
        RowBox[{"lights", "[", 
         RowBox[{"[", "lightIndex", "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"uLight", "=", 
        RowBox[{"get2D", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"uScattering", "=", 
        RowBox[{"get2D", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"li", "=", 
        RowBox[{"estimateDirect", "[", 
         RowBox[{
         "isect", ",", "uScattering", ",", "light", ",", "uLight", ",", 
          "False", ",", "False"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "li"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"beta", "=", "1"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"camRayo", "=", "eyePt"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"camRayd", "=", 
   RowBox[{"generateRayDifferential", "[", 
    RowBox[{"{", 
     RowBox[{"80", ",", "61"}], "}"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"isect", "=", 
   RowBox[{"sceneIntersect", "[", 
    RowBox[{"{", 
     RowBox[{"camRayo", ",", "camRayd"}], "}"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"isect", "=", 
   RowBox[{"computeScatteringFunctions", "[", "isect", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ld", "=", 
    RowBox[{"beta", "*", 
     RowBox[{"uniformSampleOneLight", "[", "isect", "]"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"gPrint", "[", "\"\<DiffuseAreaLight::Sample_Li\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", "ld"}], "Input",
 CellChangeTimes->{{3.838087622015506*^9, 3.8380876280143137`*^9}},
 CellLabel->
  "In[3391]:=",ExpressionUUID->"5333da9f-a037-4287-b759-352b297b65c5"],

Cell[BoxData[
 StyleBox["\<\" DiffuseAreaLight::Sample_Li\"\>",
  StripOnInput->False,
  FontSize->18,
  Background->RGBColor[0.87, 0.94, 1]]], "Print",
 CellChangeTimes->{3.8380876287877927`*^9},
 CellLabel->
  "During evaluation of \
In[3391]:=",ExpressionUUID->"05a41a0d-f850-4966-929a-e8092bdc203b"],

Cell[BoxData[
 RowBox[{"\[LeftAssociation]", 
  RowBox[{
   RowBox[{"\<\"li\"\>", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{"20.746721`", ",", "10.823384`", ",", "2.76459`"}], "}"}]}], ",", 
   RowBox[{"\<\"wi\"\>", "\[Rule]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"-", "0.5022021012998045`"}], ",", 
      RowBox[{"-", "0.435640995538612`"}], ",", "0.7470006509074727`"}], 
     "}"}]}], ",", 
   RowBox[{"\<\"pdf\"\>", "\[Rule]", "50.47296028952312`"}]}], 
  "\[RightAssociation]"}]], "Output",
 CellChangeTimes->{{3.8380875758932533`*^9, 3.8380875906217327`*^9}, 
   3.8380876287897863`*^9},
 CellLabel->
  "Out[3448]=",ExpressionUUID->"5062863f-7c2d-4778-b1d7-66a478f1821e"]
}, Open  ]]
},
WindowSize->{764, 770},
WindowMargins->{{284, Automatic}, {47, Automatic}},
FrontEndVersion->"12.0 for Microsoft Windows (64-bit) (April 8, 2019)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 47802, 1220, 6945, "Input",ExpressionUUID->"5333da9f-a037-4287-b759-352b297b65c5"],
Cell[48385, 1244, 303, 8, 30, "Print",ExpressionUUID->"05a41a0d-f850-4966-929a-e8092bdc203b"],
Cell[48691, 1254, 688, 17, 32, "Output",ExpressionUUID->"5062863f-7c2d-4778-b1d7-66a478f1821e"]
}, Open  ]]
}
]
*)

