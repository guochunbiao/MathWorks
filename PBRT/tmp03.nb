(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    121063,       2866]
NotebookOptionsPosition[    120628,       2850]
NotebookOutlinePosition[    120971,       2865]
CellTagsIndexPosition[    120928,       2862]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"SetDirectory", "[", 
   RowBox[{"FileNameJoin", "@", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"ParentDirectory", "[", 
       RowBox[{"NotebookDirectory", "[", "]"}], "]"}], ",", 
      "\"\<Shared\>\""}], "}"}]}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Needs", "[", "\"\<gPlots3DEx`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Needs", "[", "\"\<gPlotsEx`\>\"", "]"}], ";"}], 
  " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Needs", "[", "\"\<gBRDF`\>\"", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Needs", "[", "\"\<gUtils`\>\"", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SetDirectory", "[", 
    RowBox[{"NotebookDirectory", "[", "]"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ClearAll", "[", 
    RowBox[{
    "scene", ",", "camera", ",", "eyePt", ",", "lookPt", ",", "upDir", ",", 
     "fov", ",", "lights", ",", "prims", ",", "\[IndentingNewLine]", 
     "camBoundMin", ",", "camBoundMax", ",", "rasterToCam", ",", 
     "xformRasterToCamera", ",", "\[IndentingNewLine]", "gGetCameraSample", 
     ",", "get1D", ",", "get2D", ",", "invPi", ",", "powerHeuristic", ",", 
     "\[IndentingNewLine]", "rayMaxDist", ",", "camRayo", ",", "camRayd", ",",
      "calcTriNormal", ",", "triIntersect", ",", "sceneIntersect", ",", 
     "\[IndentingNewLine]", "isect", ",", "getUVs", ",", "bsdf", ",", 
     "computeScatteringFunctions", ",", "uniformSampleOneLight", ",", 
     "\[IndentingNewLine]", "l", ",", "li", ",", "ld", ",", "beta", ",", 
     "estimateDirect", ",", "lightSampleLi", ",", "triSample", ",", 
     "uniformSampleTri", ",", "\[IndentingNewLine]", "shapeSample", ",", 
     "triArea", ",", "lightL", ",", "bsdfWorldToLocal", ",", 
     "bsdfLocalToWorld", ",", "\[IndentingNewLine]", "lambertReflF", ",", 
     "bsdfPdf", ",", "bxxxdfPdf", ",", "testPixels", ",", "getTestPixelColor",
      ",", "\[IndentingNewLine]", "validatePixels", ",", "validateOnePixel", 
     ",", "\[IndentingNewLine]", "gCosineSampleHemisphere", ",", "bxxxdfF", 
     ",", "renderPixel", ",", "pixelA", ",", "pixelB", ",", "colorEquals", 
     ",", "\[IndentingNewLine]", "imgSettings", ",", "resx", ",", "resy", ",",
      "graphList", ",", "createPolyGraphs", ",", "imgTable", ",", "isBlack", 
     ",", "\[IndentingNewLine]", "resultFlag", ",", "testRender", ",", 
     "logCameraRay", ",", "lightPdfLi", ",", "shapePdf", ",", "isectSpawnRay",
      ",", "\[IndentingNewLine]", "currLogger", ",", "currBounce"}], "]"}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"invPi", "=", "0.31830988618379067154"}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"get", " ", "sampling", " ", "data", " ", "by", " ", "x"}], ",", 
    RowBox[{"y", " ", "and", " ", "dimension"}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"gGetCameraSample", "[", 
     RowBox[{"x_", ",", "y_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"dim", ",", "startIdx", ",", "sampValue", ",", "data"}], "}"}],
       ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"dim", "=", "2"}], ";", "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"sampValue", "=", "0.5"}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"For", "[", 
          RowBox[{
           RowBox[{"i", "=", "0"}], ",", 
           RowBox[{"i", "<", "dim"}], ",", 
           RowBox[{"i", "++"}], ",", 
           RowBox[{"AppendTo", "[", 
            RowBox[{"data", ",", 
             RowBox[{"dataArray", "[", 
              RowBox[{"[", 
               RowBox[{"startIdx", "+", "i"}], "]"}], "]"}]}], "]"}]}], "]"}],
          ";"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"data", "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"x", "+", "sampValue"}], ",", 
          RowBox[{"y", "+", "sampValue"}]}], "}"}]}], ";", 
       "\[IndentingNewLine]", "data"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"load", " ", "scene", " ", "data"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"scene", "=", 
   RowBox[{"ToExpression", "[", 
    RowBox[{"Import", "[", "\"\<cornell-tiny.scene\>\"", "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"camera", "=", 
   RowBox[{
    RowBox[{"scene", "[", "\"\<camera\>\"", "]"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"eyePt", "=", 
   RowBox[{"camera", "[", "\"\<eyePt\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"lookPt", "=", 
   RowBox[{"camera", "[", "\"\<lookPt\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"upDir", "=", 
   RowBox[{"camera", "[", "\"\<upDir\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{"camera", "[", "\"\<fov\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fov", "=", 
   RowBox[{
    FractionBox["fov", "180"], "\[Pi]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"camBoundMin", "=", 
   RowBox[{"camera", "[", "\"\<boundMin\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"camBoundMax", "=", 
   RowBox[{"camera", "[", "\"\<boundMax\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"rasterToCam", "=", 
   RowBox[{"camera", "[", "\"\<rasterToCam\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"lights", "=", 
   RowBox[{"scene", "[", "\"\<lights\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"prims", "=", 
   RowBox[{"scene", "[", "\"\<prims\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"imgSettings", "=", 
   RowBox[{
    RowBox[{"scene", "[", "\"\<image\>\"", "]"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"resx", "=", 
   RowBox[{"imgSettings", "[", "\"\<resx\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"resy", "=", 
   RowBox[{"imgSettings", "[", "\"\<resy\>\"", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Assert", "[", 
    RowBox[{
     RowBox[{"resx", ">", "0"}], "&&", 
     RowBox[{"resy", ">", "0"}]}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"get1D", "[", "]"}], ":=", "0.5"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"get2D", "[", "]"}], ":=", 
    RowBox[{"{", 
     RowBox[{"0.5", ",", "0.5"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "transform", " ", "raster", " ", "point", " ", "to", " ", "world", " ", 
    "point"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"xformRasterToCamera", "[", "rasterPt_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "worldPt", ",", "m", ",", "x", ",", "y", ",", "z", ",", "xp", ",", 
        "yp", ",", "zp", ",", "wp", ",", "dirRHS"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"m", "=", "rasterToCam"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"x", "=", 
        RowBox[{"rasterPt", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"y", "=", 
        RowBox[{"rasterPt", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"z", "=", "0"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", "  ", 
       RowBox[{"xp", "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "x"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "y"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", "z"}], "+", 
         RowBox[{
          RowBox[{"m", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "[", 
          RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\n", "\t", 
       RowBox[{"yp", "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "x"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "y"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", "z"}], "+", 
         RowBox[{
          RowBox[{"m", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "[", 
          RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\n", "\t", 
       RowBox[{"zp", "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "3", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "x"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "3", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "y"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "3", "]"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", "z"}], "+", 
         RowBox[{
          RowBox[{"m", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "[", 
          RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\n", "\t", 
       RowBox[{"wp", "=", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "4", "]"}], "]"}], "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "x"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "4", "]"}], "]"}], "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "y"}], "+", 
         RowBox[{
          RowBox[{
           RowBox[{"m", "[", 
            RowBox[{"[", "4", "]"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", "z"}], "+", 
         RowBox[{
          RowBox[{"m", "[", 
           RowBox[{"[", "4", "]"}], "]"}], "[", 
          RowBox[{"[", "4", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"dirRHS", "=", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"xp", ",", "zp", ",", "yp"}], "}"}], "/", "wp"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Normalize", "@", "dirRHS"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"generate", " ", "ray"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"generateRayDifferential", "[", "pixel_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"px", ",", "py", ",", "sampRasterPt", ",", "sampDir"}], "}"}], 
      ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"px", "=", 
        RowBox[{"pixel", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"py", "=", 
        RowBox[{"pixel", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"sampRasterPt", "=", 
        RowBox[{"gGetCameraSample", "[", 
         RowBox[{"px", ",", "py"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"sampDir", "=", 
        RowBox[{"xformRasterToCamera", "[", "sampRasterPt", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Normalize", "@", "sampDir"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"getUVs", "[", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"0", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "0"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "1"}], "}"}]}], "}"}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Triangle", "::", "Intersect"}], " ", "cross", " ", "op", " ", 
    "is", " ", "changed", " ", "to", " ", "RHS"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"calcTriNormal", "[", "tri_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "dp02", ",", "dp12", ",", "n", ",", "uv", ",", "duv02", ",", "duv12", 
        ",", "determinant", ",", "degenerateUV", ",", "invdet", ",", 
        "\[IndentingNewLine]", "\t", "dpdu", ",", "dpdv"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"dp02", "=", 
        RowBox[{
         RowBox[{"tri", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "-", 
         RowBox[{"tri", "[", 
          RowBox[{"[", "3", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"dp12", "=", 
        RowBox[{
         RowBox[{"tri", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"tri", "[", 
          RowBox[{"[", "3", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", "=", 
        RowBox[{"Normalize", "@", 
         RowBox[{"Cross", "[", 
          RowBox[{"dp12", ",", "dp02"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"calculate", " ", "dpdu"}], ",", " ", "dpdv"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"uv", "=", 
        RowBox[{"getUVs", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"duv02", "=", 
        RowBox[{
         RowBox[{"uv", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "-", 
         RowBox[{"uv", "[", 
          RowBox[{"[", "3", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"duv12", "=", 
        RowBox[{
         RowBox[{"uv", "[", 
          RowBox[{"[", "2", "]"}], "]"}], "-", 
         RowBox[{"uv", "[", 
          RowBox[{"[", "3", "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"determinant", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"duv02", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", 
          RowBox[{"duv12", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "-", 
         RowBox[{
          RowBox[{"duv02", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", 
          RowBox[{"duv12", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"degenerateUV", "=", 
        RowBox[{"determinant", "<", "0.000001"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", 
        RowBox[{"(", 
         RowBox[{"!", "degenerateUV"}], ")"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"invdet", "=", 
        RowBox[{"1", "/", "determinant"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"dpdu", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"duv12", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "*", "dp02"}], "-", 
           RowBox[{
            RowBox[{"duv02", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "*", "dp12"}]}], ")"}], "*", 
         "invdet"}]}], ";", "\n", "\t", 
       RowBox[{"dpdv", "=", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"-", 
             RowBox[{"duv12", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "*", "dp02"}], "+", 
           RowBox[{
            RowBox[{"duv02", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "*", "dp12"}]}], ")"}], "*", 
         "invdet"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"n", ",", "dpdu", ",", "dpdv"}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"rayMaxDist", "=", "10000"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Triangle", "::", "Intersect"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"triIntersect", "[", 
     RowBox[{"ray_", ",", "tri_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "rayo", ",", "rayd", ",", "R", ",", "L", ",", "d", ",", "curve", ",", 
        "t", ",", "sol", ",", "solT", ",", "pt", ",", "norm"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"rayo", "=", 
        RowBox[{"ray", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rayd", "=", 
        RowBox[{"ray", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"R", "=", 
        RowBox[{"Triangle", "[", "tri", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"L", "=", 
        RowBox[{"Line", "[", 
         RowBox[{"{", 
          RowBox[{"rayo", ",", 
           RowBox[{"rayo", "+", 
            RowBox[{"rayd", "*", "rayMaxDist"}]}]}], "}"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"d", "=", 
        RowBox[{"RegionDistance", "[", "R", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"curve", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{"1", "-", "t"}], ")"}], " ", 
          RowBox[{"L", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}]}], "+", 
         RowBox[{"t", " ", 
          RowBox[{"L", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "2"}], "]"}], "]"}]}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"https", ":"}], "//", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"mathematica", ".", "stackexchange", ".", "com"}], "/", 
             "questions"}], "/", "187688"}], "/", "how"}], "-", "to", "-", 
          "find", "-", "the", "-", "cells", "-", "of", "-", "a", "-", 
          "region", "-", "that", "-", "intersect", "-", "a", "-", "line"}]}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"sol", "=", 
        RowBox[{"Quiet", "@", 
         RowBox[{"Check", "[", 
          RowBox[{
           RowBox[{"FindRoot", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"d", "[", "curve", "]"}], "\[Equal]", "0"}], ",", 
             RowBox[{"{", 
              RowBox[{"t", ",", "0", ",", "1"}], "}"}], ",", 
             RowBox[{"Method", "\[Rule]", "\"\<Secant\>\""}]}], "]"}], ",", 
           "\[IndentingNewLine]", "\"\<NaN\>\"", ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"FindRoot", "::", "lstol"}], ",", 
             RowBox[{"FindRoot", "::", "jsing"}], ",", 
             RowBox[{"FindRoot", "::", "cvmit"}]}], "}"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"solT", "=", 
        RowBox[{"sol", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"ToString", "@", "sol"}], "\[NotEqual]", "\"\<NaN\>\""}], "&&", 
          RowBox[{"0.00001", "\[LessEqual]", "solT", "\[LessEqual]", "1"}]}], 
         ",", 
         RowBox[{"pt", "=", 
          RowBox[{"curve", "/.", "sol"}]}], ",", 
         RowBox[{"pt", "=", "\"\<NaN\>\""}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"norm", "=", 
        RowBox[{"calcTriNormal", "[", "tri", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"pt", ",", 
         RowBox[{"norm", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "}"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Scene", "::", "Intersect"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"sceneIntersect", "[", "ray_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "rayo", ",", "rayd", ",", "prim", ",", "light", ",", "tri", ",", 
        "dist", ",", "triInts", ",", "intsNormal", ",", "minDist", ",", 
        "minIntsPt", ",", "\[IndentingNewLine]", "minPrim", ",", "minTri", 
        ",", "minNormal", ",", "minIsLight", ",", "dpdu", ",", "dpdv", ",", 
        "material", ",", "i"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"rayo", "=", 
        RowBox[{"ray", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"rayd", "=", 
        RowBox[{"ray", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"minDist", "=", "rayMaxDist"}], " ", ";", 
       "\[IndentingNewLine]", 
       RowBox[{"minPrim", "=", "\"\<NaN\>\""}], ";", "\[IndentingNewLine]", 
       RowBox[{"minTri", "=", "\"\<NaN\>\""}], ";", "\[IndentingNewLine]", 
       RowBox[{"minIntsPt", "=", "\"\<NaN\>\""}], ";", "\[IndentingNewLine]", 
       RowBox[{"minIsLight", "=", "False"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"testing", " ", "geometry", " ", "primitives"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", "1"}], ",", 
         RowBox[{"i", "\[LessEqual]", 
          RowBox[{"Length", "[", "prims", "]"}]}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"prim", "=", 
           RowBox[{"prims", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"tri", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"prim", ",", "\"\<tri\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"triInts", ",", "intsNormal"}], "}"}], "=", 
           RowBox[{"triIntersect", "[", 
            RowBox[{"ray", ",", "tri"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"ToString", "@", "triInts"}], "\[Equal]", 
             "\"\<NaN\>\""}], ",", 
            RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"Assert", "[", 
           RowBox[{
            RowBox[{"Length", "[", "triInts", "]"}], "\[Equal]", "3"}], "]"}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"dist", "=", 
           RowBox[{"Norm", "[", 
            RowBox[{"triInts", "-", "rayo"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"dist", "\[GreaterEqual]", "minDist"}], ",", 
            RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"minPrim", "=", "prim"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minDist", "=", "dist"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minTri", "=", "tri"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minIntsPt", "=", "triInts"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minIsLight", "=", "False"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"testing", " ", "light", " ", "primitives"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", "1"}], ",", 
         RowBox[{"i", "\[LessEqual]", 
          RowBox[{"Length", "[", "lights", "]"}]}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"light", "=", 
           RowBox[{"lights", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"tri", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"light", ",", "\"\<tri\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"triInts", ",", "intsNormal"}], "}"}], "=", 
           RowBox[{"triIntersect", "[", 
            RowBox[{"ray", ",", "tri"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"ToString", "@", "triInts"}], "\[Equal]", 
             "\"\<NaN\>\""}], ",", 
            RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", 
           RowBox[{
            RowBox[{"Return", "[", 
             RowBox[{"{", 
              RowBox[{"ray", ",", "tri"}], "}"}], "]"}], ";"}], "*)"}], 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"Assert", "[", 
           RowBox[{
            RowBox[{"Length", "[", "triInts", "]"}], "\[Equal]", "3"}], "]"}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"dist", "=", 
           RowBox[{"Norm", "[", 
            RowBox[{"triInts", "-", "rayo"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"dist", "\[GreaterEqual]", "minDist"}], ",", 
            RowBox[{"Continue", "[", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"minPrim", "=", "light"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minDist", "=", "dist"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minTri", "=", "tri"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minIntsPt", "=", "triInts"}], ";", "\[IndentingNewLine]", 
          RowBox[{"minIsLight", "=", "True"}], ";"}]}], "\[IndentingNewLine]",
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"ToString", "@", "minPrim"}], "\[Equal]", "\"\<NaN\>\""}], 
         ",", 
         RowBox[{"Return", "[", "\"\<NaN\>\"", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"minNormal", ",", "dpdu", ",", "dpdv"}], "}"}], "=", 
        RowBox[{"calcTriNormal", "[", "minTri", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"material", "=", 
        RowBox[{"gAssocData", "[", 
         RowBox[{"minPrim", ",", "\"\<material\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", "result", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{
         RowBox[{"\"\<p\>\"", "\[Rule]", "minIntsPt"}], ",", 
         RowBox[{"\"\<n\>\"", "\[Rule]", "minNormal"}], ",", 
         RowBox[{"\"\<wo\>\"", "\[Rule]", 
          RowBox[{"-", "rayd"}]}], ",", 
         RowBox[{"\"\<isLight\>\"", "\[Rule]", "minIsLight"}], ",", 
         "\[IndentingNewLine]", "\t", 
         RowBox[{"\"\<dpdu\>\"", "\[Rule]", "dpdu"}], ",", 
         RowBox[{"\"\<dpdv\>\"", "\[Rule]", "dpdv"}], ",", 
         "\[IndentingNewLine]", "\t", 
         RowBox[{"\"\<tri\>\"", "\[Rule]", "minTri"}], ",", 
         RowBox[{"\"\<material\>\"", "\[Rule]", "material"}]}], "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"BSDF", "::", "BSDF"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"constructBSDF", "[", 
     RowBox[{"si_", ",", "eta_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"ns", ",", "ss", ",", "ts"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ns", "=", 
        RowBox[{"si", "[", "\"\<n\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ss", "=", 
        RowBox[{"Normalize", "@", 
         RowBox[{"si", "[", "\"\<dpdu\>\"", "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ts", "=", 
        RowBox[{"Cross", "[", 
         RowBox[{"ss", ",", "ns"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{
         RowBox[{"\"\<eta\>\"", "\[Rule]", "eta"}], ",", 
         RowBox[{"\"\<ns\>\"", "\[Rule]", "ns"}], ",", 
         RowBox[{"\"\<ng\>\"", "\[Rule]", 
          RowBox[{"si", "[", "\"\<n\>\"", "]"}]}], ",", 
         RowBox[{"\"\<ss\>\"", "\[Rule]", "ss"}], ",", 
         RowBox[{"\"\<ts\>\"", "\[Rule]", "ts"}]}], "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"geometry", " ", "plot", " ", "graph"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"graphList", "=", 
   RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"createPolyGraphs", "[", "elems_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "i", ",", "elem", ",", "tri", ",", "mat", ",", "Kd", ",", "sigma"}], 
       "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", "1"}], ",", 
         RowBox[{"i", "\[LessEqual]", 
          RowBox[{"Length", "[", "elems", "]"}]}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"elem", "=", 
           RowBox[{"elems", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"tri", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"elem", ",", "\"\<tri\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"mat", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"elem", ",", "\"\<material\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Kd", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"mat", ",", "\"\<Kd\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"sigma", "=", 
           RowBox[{"gAssocData", "[", 
            RowBox[{"mat", ",", "\"\<sigma\>\""}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"AppendTo", "[", 
           RowBox[{"graphList", ",", 
            RowBox[{"RGBColor", "[", "Kd", "]"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"AppendTo", "[", 
           RowBox[{"graphList", ",", 
            RowBox[{"Polygon", "[", "tri", "]"}]}], "]"}]}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"createPolyGraphs", "[", "lights", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"createPolyGraphs", "[", "prims", "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"isBlack", "[", "f_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"f", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "\[Equal]", "0"}], "&&", 
         RowBox[{
          RowBox[{"f", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "\[Equal]", "0"}], "&&", 
         RowBox[{
          RowBox[{"f", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "\[Equal]", "0"}]}], ",", "True", 
        ",", "False"}], "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"MatteMaterial", "::", "ComputeScatteringFunctions"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"computeScatteringFunctions", "[", "si_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"bsdf", ",", "material", ",", "r", ",", "sig", ",", "newsi"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"bsdf", "=", 
        RowBox[{"constructBSDF", "[", 
         RowBox[{"si", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"material", "=", 
        RowBox[{"si", "[", "\"\<material\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"r", "=", 
        RowBox[{"material", "[", "\"\<Kd\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"sig", "=", 
        RowBox[{"material", "[", "\"\<sigma\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"sig", "=", 
        RowBox[{"Clip", "[", 
         RowBox[{"sig", ",", 
          RowBox[{"{", 
           RowBox[{"0", ",", "90"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"not", " ", "black"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"r", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "\[NotEqual]", "0"}], "||", 
         RowBox[{
          RowBox[{"r", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "\[NotEqual]", "0"}], "||", 
         RowBox[{
          RowBox[{"r", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "\[NotEqual]", "0"}]}], "]"}], ";",
        "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{"sig", "\[Equal]", "0"}], "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"bsdf", "[", "\"\<bxdfs0\>\"", "]"}], "=", 
        RowBox[{"<|", 
         RowBox[{
          RowBox[{"\"\<type\>\"", "\[Rule]", "\"\<LambertianReflection\>\""}],
           ",", 
          RowBox[{"\"\<R\>\"", "\[Rule]", "r"}]}], "|>"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"newsi", "=", "si"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"newsi", "[", "\"\<bsdf\>\"", "]"}], "=", "bsdf"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "newsi"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "UniformSampleTriangle", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"uniformSampleTri", "[", "u_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "su0", "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"su0", "=", 
        RowBox[{"Sqrt", "[", 
         RowBox[{"u", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"1", "-", "su0"}], ",", 
         RowBox[{
          RowBox[{"u", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "su0"}]}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Triangle", "::", "Area"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"triArea", "[", "tri_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"p0", ",", "p1", ",", "p2", ",", "area"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"p0", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p1", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p2", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"area", "=", 
        RowBox[{"0.5", "*", 
         RowBox[{"Norm", "@", 
          RowBox[{"Cross", "[", 
           RowBox[{
            RowBox[{"p2", "-", "p0"}], ",", 
            RowBox[{"p1", "-", "p0"}]}], "]"}]}]}]}], ";", 
       "\[IndentingNewLine]", "area"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Triangle", "::", "Sample"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"triSample", "[", 
     RowBox[{"tri_", ",", "u_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "b", ",", "p0", ",", "p1", ",", "p2", ",", "itP", ",", "itN", ",", 
        "itError", ",", "pAbsSum", ",", "gamma6", ",", "pdf"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"b", "=", 
        RowBox[{"uniformSampleTri", "[", "u", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"p0", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p1", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p2", "=", 
        RowBox[{"tri", "[", 
         RowBox[{"[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"itP", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"b", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "p0"}], "+", 
         RowBox[{
          RowBox[{"b", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "p1"}], "+", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"1", "-", 
            RowBox[{"b", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "-", 
            RowBox[{"b", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], ")"}], "*", "p2"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"itN", "=", 
        RowBox[{"Normalize", "@", 
         RowBox[{"Cross", "[", 
          RowBox[{
           RowBox[{"p2", "-", "p0"}], ",", 
           RowBox[{"p1", "-", "p0"}]}], "]"}]}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"pAbsSum", "=", 
        RowBox[{
         RowBox[{"Abs", "[", 
          RowBox[{
           RowBox[{"b", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "*", "p0"}], "]"}], "+", 
         RowBox[{"Abs", "[", 
          RowBox[{
           RowBox[{"b", "[", 
            RowBox[{"[", "2", "]"}], "]"}], "*", "p1"}], "]"}], "+", 
         RowBox[{"Abs", "[", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"1", "-", 
             RowBox[{"b", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "-", 
             RowBox[{"b", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ")"}], "*", "p2"}], "]"}]}]}],
        ";", "\[IndentingNewLine]", 
       RowBox[{"gamma6", "=", 
        RowBox[{"3.57628011", "*", 
         RowBox[{"10", "^", 
          RowBox[{"-", "7"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"itError", "=", 
        RowBox[{"gamma6", "*", "pAbsSum"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"pdf", "=", 
        RowBox[{"1", "/", 
         RowBox[{"triArea", "[", "tri", "]"}]}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{
         RowBox[{"\"\<p\>\"", "\[Rule]", "itP"}], ",", 
         RowBox[{"\"\<n\>\"", "\[Rule]", "itN"}], ",", 
         RowBox[{"\"\<error\>\"", "\[Rule]", "itError"}], ",", 
         RowBox[{"\"\<pdf\>\"", "\[Rule]", "pdf"}]}], "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Shape", "::", "Sample"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"shapeSample", "[", 
     RowBox[{"light_", ",", "si_", ",", "u_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "tri", ",", " ", "intr", ",", "wi", ",", "distSquared", ",", "pdf", 
        ",", "denom"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"tri", "=", 
        RowBox[{"gAssocData", "[", 
         RowBox[{"light", ",", "\"\<tri\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"intr", "=", 
        RowBox[{"triSample", "[", 
         RowBox[{"tri", ",", "u"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"wi", "=", 
        RowBox[{
         RowBox[{"intr", "[", "\"\<p\>\"", "]"}], "-", 
         RowBox[{"si", "[", "\"\<p\>\"", "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{"Norm", "[", "wi", "]"}], ">", "0"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"wi", "=", 
        RowBox[{"Normalize", "@", "wi"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"P838", " ", "&"}], " ", "P875"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Convert", " ", "from", " ", "area", " ", "measure", " ", "to", " ", 
         "solid", " ", "angle", " ", 
         RowBox[{"measure", "."}]}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"https", ":"}], "//", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"computergraphics", ".", "stackexchange", ".", "com"}], 
             "/", "questions"}], "/", "8032"}], "/", "how"}], "-", "can", "-",
           "we", "-", "convert", "-", "a", "-", "probability", "-", "density",
           "-", "according", "-", "to", "-", "solid", "-", "angle", "-", "to",
           "-", "a", "-", "density", "-", "a"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"distSquared", "=", 
        RowBox[{
         RowBox[{"Norm", "[", 
          RowBox[{
           RowBox[{"intr", "[", "\"\<p\>\"", "]"}], "-", 
           RowBox[{"si", "[", "\"\<p\>\"", "]"}]}], "]"}], "^", "2"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"denom", "=", 
        RowBox[{"Abs", "@", 
         RowBox[{"Dot", "[", 
          RowBox[{
           RowBox[{"intr", "[", "\"\<n\>\"", "]"}], ",", 
           RowBox[{"-", "wi"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"pdf", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"denom", "\[Equal]", "0"}], ",", "0", ",", 
          RowBox[{
           RowBox[{"intr", "[", "\"\<pdf\>\"", "]"}], "*", 
           RowBox[{"distSquared", "/", "denom"}]}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"intr", "[", "\"\<pdf\>\"", "]"}], "=", "pdf"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "intr"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"DiffuseAreaLight", "::", "L"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"lightL", "[", 
     RowBox[{"surfNormal_", ",", "w_", ",", "lightMat_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "kd", "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"kd", "=", 
        RowBox[{"lightMat", "[", "\"\<Kd\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Dot", "[", 
           RowBox[{"surfNormal", ",", "w"}], "]"}], ">", "0"}], ",", "kd", 
         ",", 
         RowBox[{"{", 
          RowBox[{"0", ",", "0", ",", "0"}], "}"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"DiffuseAreaLight", "::", "Sample_Li"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"lightSampleLi", "[", 
     RowBox[{"light_", ",", "ref_", ",", "u_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"pShape", ",", "wi", ",", "vis", ",", "l"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"pShape", "=", 
        RowBox[{"shapeSample", "[", 
         RowBox[{"light", ",", "ref", ",", "u"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"wi", "=", 
        RowBox[{"Normalize", "[", 
         RowBox[{
          RowBox[{"pShape", "[", "\"\<p\>\"", "]"}], "-", 
          RowBox[{"ref", "[", "\"\<p\>\"", "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"vis", "=", 
        RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"l", "=", 
        RowBox[{"lightL", "[", 
         RowBox[{
          RowBox[{"pShape", "[", "\"\<n\>\"", "]"}], ",", 
          RowBox[{"-", "wi"}], ",", 
          RowBox[{"light", "[", "\"\<material\>\"", "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{
         RowBox[{"\"\<li\>\"", "\[Rule]", "l"}], ",", 
         RowBox[{"\"\<wi\>\"", "\[Rule]", "wi"}], ",", 
         RowBox[{"\"\<pdf\>\"", "\[Rule]", 
          RowBox[{"pShape", "[", "\"\<pdf\>\"", "]"}]}]}], "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"Interaction", "::", "SpawnRay"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"isectSpawnRay", "[", 
     RowBox[{"ref_", ",", "d_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "o", "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"o", "=", 
        RowBox[{"ref", "[", "\"\<p\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"o", ",", "d"}], "}"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"DiffuseAreaLight", "::", "Pdf_Li"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"shapePdf", "[", 
     RowBox[{"tri_", ",", "ref_", ",", "wi_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "rayo", ",", "rayd", ",", "intsPt", ",", "intsNormal", ",", "denom", 
        ",", "pdf"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"rayo", ",", "rayd"}], "}"}], "=", 
        RowBox[{"isectSpawnRay", "[", 
         RowBox[{"ref", ",", "wi"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"intsPt", ",", "intsNormal"}], "}"}], "=", 
        RowBox[{"triIntersect", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"rayo", ",", "rayd"}], "}"}], ",", "tri"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"ToString", "@", "intsPt"}], "\[Equal]", "\"\<NaN\>\""}], 
         ",", 
         RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"denom", "=", 
        RowBox[{
         RowBox[{"Abs", "@", 
          RowBox[{"Dot", "[", 
           RowBox[{"intsNormal", ",", 
            RowBox[{"-", "wi"}]}], "]"}]}], "*", 
         RowBox[{"triArea", "[", "tri", "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"denom", "\[Equal]", "0"}], ",", 
         RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "Convert", " ", "light", " ", "sample", " ", "weight", " ", "to", " ",
          "solid", " ", "angle", " ", "measure"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"pdf", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"Norm", "[", 
           RowBox[{
            RowBox[{"ref", "[", "\"\<p\>\"", "]"}], "-", "intsPt"}], "]"}], 
          "^", "2"}], "/", "denom"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", "pdf"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"DiffuseAreaLight", "::", "Pdf_Li"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"lightPdfLi", "[", 
     RowBox[{"light_", ",", "ref_", ",", "wi_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "tri", "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{"{", 
          RowBox[{"light", ",", "ref", ",", "wi"}], "}"}], "]"}], ";"}], 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"tri", "=", 
        RowBox[{"light", "[", "\"\<tri\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"shapePdf", "[", 
        RowBox[{"tri", ",", "ref", ",", "wi"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"BSDF", "::", "WorldToLocal"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"bsdfWorldToLocal", "[", 
     RowBox[{"bsdf_", ",", "v_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"ss", ",", "ts", ",", "ns"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ss", "=", 
        RowBox[{"bsdf", "[", "\"\<ss\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ts", "=", 
        RowBox[{"bsdf", "[", "\"\<ts\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ns", "=", 
        RowBox[{"bsdf", "[", "\"\<ns\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"local", " ", "space", " ", "dont", " ", "need", " ", "RHS"}],
         "*)"}], "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Dot", "[", 
          RowBox[{"v", ",", "ss"}], "]"}], ",", 
         RowBox[{"Dot", "[", 
          RowBox[{"v", ",", "ts"}], "]"}], ",", 
         RowBox[{"Dot", "[", 
          RowBox[{"v", ",", "ns"}], "]"}]}], "}"}]}]}], "\[IndentingNewLine]",
      "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"bsdfLocalToWorld", "[", 
     RowBox[{"bsdf_", ",", "v_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"ss", ",", "ts", ",", "ns", ",", "x", ",", "y", ",", "z"}], 
       "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ss", "=", 
        RowBox[{"bsdf", "[", "\"\<ss\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ts", "=", 
        RowBox[{"bsdf", "[", "\"\<ts\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ns", "=", 
        RowBox[{"bsdf", "[", "\"\<ns\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"x", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"ss", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", 
          RowBox[{"v", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "+", 
         RowBox[{
          RowBox[{"ts", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", 
          RowBox[{"v", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "+", 
         RowBox[{
          RowBox[{"ns", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", 
          RowBox[{"v", "[", 
           RowBox[{"[", "3", "]"}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"y", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"ss", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", 
          RowBox[{"v", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "+", 
         RowBox[{
          RowBox[{"ts", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", 
          RowBox[{"v", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "+", 
         RowBox[{
          RowBox[{"ns", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", 
          RowBox[{"v", "[", 
           RowBox[{"[", "3", "]"}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"z", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"ss", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", 
          RowBox[{"v", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], "+", 
         RowBox[{
          RowBox[{"ts", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", 
          RowBox[{"v", "[", 
           RowBox[{"[", "2", "]"}], "]"}]}], "+", 
         RowBox[{
          RowBox[{"ns", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", 
          RowBox[{"v", "[", 
           RowBox[{"[", "3", "]"}], "]"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"ss", ",", "ts", ",", 
         RowBox[{"ns", " ", "already", " ", "in", " ", "RHS"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x", ",", "y", ",", "z"}], "}"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"LambertianReflection", "::", "f"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"lambertReflF", "[", 
     RowBox[{"bxdf_", ",", "wo_", ",", "wi_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "r", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"r", "=", 
        RowBox[{"bxdf", "[", "\"\<R\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"r", "*", "invPi"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}],
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"BSDF", "::", "f"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"bsdfF", "[", 
     RowBox[{"bsdf_", ",", "woW_", ",", "wiW_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"wi", ",", "wo", ",", "f", ",", "bxdf"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"wi", "=", 
        RowBox[{"bsdfWorldToLocal", "[", 
         RowBox[{"bsdf", ",", "wiW"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"wo", "=", 
        RowBox[{"bsdfWorldToLocal", "[", 
         RowBox[{"bsdf", ",", "woW"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"wo", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "\[Equal]", "0"}], ",", 
         RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"f", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"bxdf", "=", 
        RowBox[{"bsdf", "[", "\"\<bxdfs0\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"f", "+=", 
        RowBox[{"lambertReflF", "[", 
         RowBox[{"bxdf", ",", "wo", ",", "wi"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "f"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"BxDF", "::", "Pdf"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"bxxxdfPdf", "[", 
     RowBox[{"bxdf_", ",", "wo_", ",", "wi_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"local", " ", "space"}], ",", 
        RowBox[{"dont", " ", "need", " ", "RHS"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"wo", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "*", 
          RowBox[{"wi", "[", 
           RowBox[{"[", "3", "]"}], "]"}]}], ">", "0"}], ",", 
        RowBox[{
         RowBox[{"Abs", "[", 
          RowBox[{"wi", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "]"}], "*", "invPi"}], ",", "0"}], 
       "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"BSDF", "::", "Pdf"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"bsdfPdf", "[", 
     RowBox[{"bsdf_", ",", "woWorld_", ",", "wiWorld_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "wo", ",", "wi", ",", "pdf", ",", "bxdf", ",", "matchingComps"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"wi", "=", 
        RowBox[{"bsdfWorldToLocal", "[", 
         RowBox[{"bsdf", ",", "wiWorld"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"wo", "=", 
        RowBox[{"bsdfWorldToLocal", "[", 
         RowBox[{"bsdf", ",", "woWorld"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"wo", "[", 
           RowBox[{"[", "3", "]"}], "]"}], "\[Equal]", "0"}], ",", 
         RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"pdf", "=", "0"}], ";", "\[IndentingNewLine]", 
       RowBox[{"bxdf", "=", 
        RowBox[{"bsdf", "[", "\"\<bxdfs0\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"pdf", "+=", 
        RowBox[{"bxxxdfPdf", "[", 
         RowBox[{"bxdf", ",", "wo", ",", "wi"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"matchingComps", "=", "1"}], ";", "\[IndentingNewLine]", 
       RowBox[{"pdf", "/", "matchingComps"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"powerHeuristic", "[", 
     RowBox[{"nf_", ",", "fPdf_", ",", "ng_", ",", "gPdf_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"f", ",", "g"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"f", "=", 
        RowBox[{"nf", "*", "fPdf"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"g", "=", 
        RowBox[{"ng", "*", "gPdf"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"f", "*", 
        RowBox[{"f", "/", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"f", "*", "f"}], "+", 
           RowBox[{"g", "*", "g"}]}], ")"}]}]}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"gCosineSampleHemisphere", "[", "u_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"d", ",", "z"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Assert", "[", 
        RowBox[{"u", "\[Equal]", 
         RowBox[{"{", 
          RowBox[{"0.5", ",", "0.5"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"d", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0"}], "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"z", "=", 
        RowBox[{"Sqrt", "@", 
         RowBox[{"Max", "[", 
          RowBox[{"0", ",", 
           RowBox[{"1", "-", 
            RowBox[{
             RowBox[{"d", "[", 
              RowBox[{"[", "1", "]"}], "]"}], "*", 
             RowBox[{"d", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "-", 
            RowBox[{
             RowBox[{"d", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "*", 
             RowBox[{"d", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}]}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"local", " ", "space"}], ",", " ", 
         RowBox[{"dont", " ", "need", " ", "RHS"}]}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"d", "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", 
         RowBox[{"d", "[", 
          RowBox[{"[", "2", "]"}], "]"}], ",", "z"}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"LambertianReflection", "::", "f"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"bxxxdfF", "[", 
     RowBox[{"bxdf_", ",", "wo_", ",", "wi_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"bxdf", "[", "\"\<R\>\"", "]"}], "*", "invPi"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"BxDF", "::", "Sample_f"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"bxxxdfSampleF", "[", 
     RowBox[{"bxdf_", ",", "wo_", ",", "u_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"wi", ",", "pdf", ",", "f"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"wi", "=", 
        RowBox[{"gCosineSampleHemisphere", "[", "u", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", "RHS", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"wo", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "<", "0"}], ",", 
         RowBox[{
          RowBox[{"wi", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*=", 
          RowBox[{"-", "1"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"pdf", "=", 
        RowBox[{"bxxxdfPdf", "[", 
         RowBox[{"bxdf", ",", "wo", ",", "wi"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"f", "=", 
        RowBox[{"bxxxdfF", "[", 
         RowBox[{"bxdf", ",", "wo", ",", "wi"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"f", ",", "wi", ",", "pdf"}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"BSDF", "::", "Sample_f"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"bsdfSampleF", "[", 
     RowBox[{"bsdf_", ",", "woWorld_", ",", "u_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "uRemapped", ",", "wi", ",", "wo", ",", "bxdf", ",", "f", ",", 
        "wiWorld", ",", "pdf", ",", "ng", ",", "reflect"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"uRemapped", "=", "u"}], ";", "\[IndentingNewLine]", 
       RowBox[{"wo", "=", 
        RowBox[{"bsdfWorldToLocal", "[", 
         RowBox[{"bsdf", ",", "woWorld"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"bxdf", "=", 
        RowBox[{"bsdf", "[", "\"\<bxdfs0\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"f", ",", "wi", ",", "pdf"}], "}"}], "=", 
        RowBox[{"bxxxdfSampleF", "[", 
         RowBox[{"bxdf", ",", "wo", ",", "uRemapped"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"wiWorld", "=", 
        RowBox[{"bsdfLocalToWorld", "[", 
         RowBox[{"bsdf", ",", "wi"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ng", "=", 
        RowBox[{"bsdf", "[", "\"\<ng\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"reflect", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"Dot", "[", 
           RowBox[{"wiWorld", ",", "ng"}], "]"}], "*", 
          RowBox[{"Dot", "[", 
           RowBox[{"woWorld", ",", "ng"}], "]"}]}], ">", "0"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"f", "=", "0"}], ";", "\[IndentingNewLine]", 
       RowBox[{"f", "+=", 
        RowBox[{"bxxxdfF", "[", 
         RowBox[{"bxdf", ",", "wo", ",", "wi"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"f", ",", "wiWorld", ",", "pdf"}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"SurfaceInteraction", "::", "Le"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"surfaceLe", "[", 
     RowBox[{"isect_", ",", "rayd_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"!", 
          RowBox[{"isect", "[", "\"\<isLight\>\"", "]"}]}], ",", 
         RowBox[{"Return", "[", 
          RowBox[{"{", 
           RowBox[{"0", ",", "0", ",", "0"}], "}"}], "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"lightL", "[", 
        RowBox[{
         RowBox[{"isect", "[", "\"\<n\>\"", "]"}], ",", "rayd", ",", 
         RowBox[{"isect", "[", "\"\<material\>\"", "]"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "EstimateDirect", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"estimateDirect", "[", 
     RowBox[{
     "it_", ",", "uScattering_", ",", "light_", ",", "uLight_", ",", 
      "handleMedia_", ",", "specular_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "li", ",", "wi", ",", "lightPdf", ",", "vis", ",", "lightLi", ",", 
        "bsdf", ",", "f1", ",", "f2", ",", "scatteringPdf", ",", "weight", 
        ",", "ld", ",", "\[IndentingNewLine]", "\t", "tmp", ",", "lightIsect",
         ",", "ray", ",", "foundSurfaceInteraction", ",", "tr"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Assert", "[", 
        RowBox[{"handleMedia", "\[Equal]", "False"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{"specular", "\[Equal]", "False"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"{", 
           RowBox[{
           "it", ",", "uScattering", ",", "light", ",", "uLight", ",", 
            "handleMedia", ",", "specular"}], "}"}], "]"}], ";"}], "*)"}], 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"lightLi", "=", 
        RowBox[{"lightSampleLi", "[", 
         RowBox[{"light", ",", "it", ",", "uLight"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"li", "=", 
        RowBox[{"lightLi", "[", "\"\<li\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"wi", "=", 
        RowBox[{"lightLi", "[", "\"\<wi\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"lightPdf", "=", 
        RowBox[{"lightLi", "[", "\"\<pdf\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"bsdf", "=", 
        RowBox[{"it", "[", "\"\<bsdf\>\"", "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"f1", ":", 
         RowBox[{"sampling", " ", "the", " ", "light"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"f1", ",", "scatteringPdf"}], "}"}], "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"isBlack", "[", "li", "]"}], "||", 
           RowBox[{"lightPdf", "\[Equal]", "0"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"0", ",", "0", ",", "0"}], "}"}], ",", "0"}], "}"}], ",",
           "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"bsdfF", "[", 
             RowBox[{"bsdf", ",", 
              RowBox[{"it", "[", "\"\<wo\>\"", "]"}], ",", "wi"}], "]"}], ",", 
            RowBox[{"bsdfPdf", "[", 
             RowBox[{"bsdf", ",", 
              RowBox[{"it", "[", "\"\<wo\>\"", "]"}], ",", "wi"}], "]"}]}], 
           "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"f1", "*=", 
        RowBox[{"Abs", "@", 
         RowBox[{"Dot", "[", 
          RowBox[{"wi", ",", 
           RowBox[{"it", "[", "\"\<n\>\"", "]"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"weight", "=", 
        RowBox[{"powerHeuristic", "[", 
         RowBox[{"1", ",", "lightPdf", ",", "1", ",", "scatteringPdf"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ld", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"!", 
          RowBox[{"isBlack", "[", "f1", "]"}]}], ",", 
         RowBox[{"ld", "+=", 
          RowBox[{"f1", "*", "li", "*", 
           RowBox[{"weight", "/", "lightPdf"}]}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"f2", ":", 
         RowBox[{"sampling", " ", "the", " ", "bxdf"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"f2", ",", "wi", ",", "scatteringPdf"}], "}"}], "=", 
        RowBox[{"bsdfSampleF", "[", 
         RowBox[{"bsdf", ",", 
          RowBox[{"it", "[", "\"\<wo\>\"", "]"}], ",", "uScattering"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tmp", "=", "f2"}], ";", "\[IndentingNewLine]", 
       RowBox[{"f2", "*=", 
        RowBox[{"Abs", "@", 
         RowBox[{"Dot", "[", 
          RowBox[{"wi", ",", 
           RowBox[{"it", "[", "\"\<n\>\"", "]"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{"!", 
          RowBox[{"isBlack", "[", "f2", "]"}]}], "&&", 
         RowBox[{"scatteringPdf", ">", "0"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"weight", "=", "1"}], ";", "\[IndentingNewLine]", " ", 
       "\[IndentingNewLine]", 
       RowBox[{"lightPdf", "=", 
        RowBox[{"lightPdfLi", "[", 
         RowBox[{"light", ",", "it", ",", "wi"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"lightPdf", "\[Equal]", "0"}], ",", 
         RowBox[{"Return", "[", "ld", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"weight", "=", 
        RowBox[{"powerHeuristic", "[", 
         RowBox[{"1", ",", "scatteringPdf", ",", "1", ",", "lightPdf"}], 
         "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
        "offset", " ", "origin", " ", "a", " ", "little", " ", "bit"}], 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"ray", "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"it", "[", "\"\<p\>\"", "]"}], "+", 
           RowBox[{"wi", "*", "0.01"}]}], ",", "wi"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"lightIsect", "=", 
        RowBox[{"sceneIntersect", "[", "ray", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"foundSurfaceInteraction", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ToString", "@", "lightIsect"}], "\[Equal]", 
           "\"\<NaN\>\""}], ",", "False", ",", "True"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", "foundSurfaceInteraction", "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"li", "=", 
        RowBox[{"surfaceLe", "[", 
         RowBox[{"lightIsect", ",", 
          RowBox[{"-", "wi"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"tr", "=", "1"}], ";", "\[IndentingNewLine]", 
       RowBox[{"ld", "+=", 
        RowBox[{"f2", "*", "li", "*", "tr", "*", 
         RowBox[{"weight", "/", "scatteringPdf"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", "ld"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", "UniformSampleOneLight", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"uniformSampleOneLight", "[", "isect_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "lightIndex", ",", "light", ",", "lightPdf", ",", "uLight", ",", 
        "uScattering", ",", "li"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"lightIndex", "=", "1"}], ";", "\[IndentingNewLine]", 
       RowBox[{"lightPdf", "=", "1"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{"1", "\[LessEqual]", "lightIndex", "\[LessEqual]", 
         RowBox[{"Length", "[", "lights", "]"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"light", "=", 
        RowBox[{"lights", "[", 
         RowBox[{"[", "lightIndex", "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"uLight", "=", 
        RowBox[{"get2D", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"uScattering", "=", 
        RowBox[{"get2D", "[", "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"li", "=", 
        RowBox[{"estimateDirect", "[", 
         RowBox[{
         "isect", ",", "uScattering", ",", "light", ",", "uLight", ",", 
          "False", ",", "False"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "li"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]",
   "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"PathIntegrator", "::", "Li"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"renderPixel", "[", "pixel_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "l", ",", "le", ",", "beta", ",", "camRayo", ",", "camRayd", ",", 
        "isect1", ",", "isect2", ",", "ld", ",", "bounces"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", "logging", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"currLogger", "=", 
        RowBox[{"<|", 
         RowBox[{"\"\<pixel\>\"", "\[Rule]", "pixel"}], "|>"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"bounces", "=", "0"}], ";", "\[IndentingNewLine]", 
       RowBox[{"l", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"beta", "=", 
        RowBox[{"{", 
         RowBox[{"1", ",", "1", ",", "1"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"camRayo", "=", "eyePt"}], ";", "\[IndentingNewLine]", 
       RowBox[{"camRayd", "=", 
        RowBox[{"generateRayDifferential", "[", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"pixel", "[", 
            RowBox[{"[", "1", "]"}], "]"}], ",", 
           RowBox[{"pixel", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], "}"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"currLogger", "[", "\"\<cameraRay\>\"", "]"}], "=", 
        RowBox[{"<|", 
         RowBox[{
          RowBox[{"\"\<o\>\"", "\[Rule]", "camRayo"}], ",", 
          RowBox[{"\"\<d\>\"", "\[Rule]", "camRayd"}]}], "|>"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"currLogger", "[", "\"\<bounces\>\"", "]"}], "=", 
        RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"currBounce", "=", 
        RowBox[{"<|", "|>"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"isect1", "=", 
        RowBox[{"sceneIntersect", "[", 
         RowBox[{"{", 
          RowBox[{"camRayo", ",", "camRayd"}], "}"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"le", "=", 
        RowBox[{"{", 
         RowBox[{"0", ",", "0", ",", "0"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"ToString", "@", "isect1"}], "\[NotEqual]", "\"\<NaN\>\""}],
          ",", "\[IndentingNewLine]", "\t", 
         RowBox[{"le", "=", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"bounces", ">", "0"}], ",", 
            RowBox[{"{", 
             RowBox[{"0", ",", "0", ",", "0"}], "}"}], ",", 
            RowBox[{"surfaceLe", "[", 
             RowBox[{"isect1", ",", 
              RowBox[{"-", "camRayd"}]}], "]"}]}], "]"}]}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"currBounce", "[", "\"\<le\>\"", "]"}], "=", "le"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"currBounce", "[", "\"\<leBeta\>\"", "]"}], "=", "beta"}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"l", "+=", 
        RowBox[{"beta", "*", "le"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"isect2", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ToString", "@", "isect1"}], "\[Equal]", "\"\<NaN\>\""}], 
          ",", "\"\<NaN\>\"", ",", 
          RowBox[{"computeScatteringFunctions", "[", "isect1", "]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ld", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ToString", "@", "isect2"}], "\[Equal]", "\"\<NaN\>\""}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"0", ",", "0", ",", "0"}], "}"}], ",", 
          RowBox[{"uniformSampleOneLight", "[", "isect2", "]"}]}], "]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"currBounce", "[", "\"\<ld\>\"", "]"}], "=", "ld"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"currBounce", "[", "\"\<ldBeta\>\"", "]"}], "=", "beta"}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"ld", "*=", "beta"}], ";", "\[IndentingNewLine]", 
       RowBox[{"l", "+=", "ld"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"currLogger", "[", "\"\<li\>\"", "]"}], "=", "l"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"AppendTo", "[", 
        RowBox[{
         RowBox[{"currLogger", "[", "\"\<bounces\>\"", "]"}], ",", 
         "currBounce"}], "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", "l"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"creating", " ", "image", " ", "table"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"imgTable", "=", 
    RowBox[{"Table", "[", 
     RowBox[{"1", ",", "resx", ",", "resy"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"testRender", "[", 
     RowBox[{"tileMin_", ",", "tileMax_", ",", 
      RowBox[{"colorMul_:", "1"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"i", ",", "j"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", "1"}], ",", 
         RowBox[{"i", "\[LessEqual]", "resx"}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{"For", "[", 
          RowBox[{
           RowBox[{"j", "=", "1"}], ",", 
           RowBox[{"j", "\[LessEqual]", "resy"}], ",", 
           RowBox[{"j", "++"}], ",", "\[IndentingNewLine]", " ", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"imgTable", "[", 
               RowBox[{"[", "i", "]"}], "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}], "=", 
             RowBox[{"RGBColor", "[", 
              RowBox[{"0", ",", "0", ",", "0"}], "]"}]}], ";"}]}], 
          "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", 
          RowBox[{
           RowBox[{"tileMin", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "+", "1"}]}], ",", 
         RowBox[{"i", "\[LessEqual]", 
          RowBox[{
           RowBox[{"tileMax", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "+", "1"}]}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"For", "[", 
           RowBox[{
            RowBox[{"j", "=", 
             RowBox[{
              RowBox[{"tileMin", "[", 
               RowBox[{"[", "2", "]"}], "]"}], "+", "1"}]}], ",", 
            RowBox[{"j", "\[LessEqual]", 
             RowBox[{
              RowBox[{"tileMax", "[", 
               RowBox[{"[", "2", "]"}], "]"}], "+", "1"}]}], ",", 
            RowBox[{"j", "++"}], ",", "\[IndentingNewLine]", " ", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"imgTable", "[", 
                RowBox[{"[", "j", "]"}], "]"}], "[", 
               RowBox[{"[", "i", "]"}], "]"}], "=", 
              RowBox[{"RGBColor", "@", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"renderPixel", "[", 
                  RowBox[{"{", 
                   RowBox[{"i", ",", "j"}], "}"}], "]"}], "*", "colorMul"}], 
                ")"}]}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"load", " ", "test", " ", "data"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"testPixels", "=", 
   RowBox[{"ToExpression", "[", 
    RowBox[{"Import", "[", "\"\<cornell-tiny.pixels\>\"", "]"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"getTestPixelColor", "[", "pixel_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"idx", ",", "x", ",", "y", ",", "z"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"idx", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"pixel", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "*", "resy", "*", "3"}], "+", 
         RowBox[{
          RowBox[{"pixel", "[", 
           RowBox[{"[", "2", "]"}], "]"}], "*", "3"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"x", "=", 
        RowBox[{"testPixels", "[", 
         RowBox[{"[", 
          RowBox[{"idx", "+", "1"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"y", "=", 
        RowBox[{"testPixels", "[", 
         RowBox[{"[", 
          RowBox[{"idx", "+", "2"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"z", "=", 
        RowBox[{"testPixels", "[", 
         RowBox[{"[", 
          RowBox[{"idx", "+", "3"}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"x", ",", "y", ",", "z"}], "}"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"colorEquals", "[", 
     RowBox[{"c1_", ",", "c2_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "\[Epsilon]", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[Epsilon]", "=", "0.001"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Abs", "[", 
           RowBox[{
            RowBox[{"c1", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "-", 
            RowBox[{"c2", "[", 
             RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "<", "0.001"}], ")"}], "&&",
         "\[IndentingNewLine]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Abs", "[", 
           RowBox[{
            RowBox[{"c1", "[", 
             RowBox[{"[", "2", "]"}], "]"}], "-", 
            RowBox[{"c2", "[", 
             RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "<", "0.001"}], ")"}], "&&",
         "\[IndentingNewLine]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Abs", "[", 
           RowBox[{
            RowBox[{"c1", "[", 
             RowBox[{"[", "3", "]"}], "]"}], "-", 
            RowBox[{"c2", "[", 
             RowBox[{"[", "3", "]"}], "]"}]}], "]"}], "<", "0.001"}], 
         ")"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"validateOnePixel", "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"pixelA", ",", "pixelB", ",", "test"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"pixelA", "=", 
        RowBox[{"renderPixel", "[", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"pixelB", "=", 
        RowBox[{"getTestPixelColor", "[", 
         RowBox[{"{", 
          RowBox[{"i", ",", "j"}], "}"}], "]"}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{"Print", "[", "pixelA", "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"Print", "[", "pixelB", "]"}], ";"}], "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"test", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"colorEquals", "[", 
           RowBox[{"pixelA", ",", "pixelB"}], "]"}], ",", "True", ",", 
          "False"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{"test", "\[Equal]", "True"}], "||", 
         RowBox[{"test", "\[Equal]", "False"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"test", ",", "pixelA"}], "}"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"validatePixels", "[", 
     RowBox[{"tileMin_", ",", "tileMax_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "i", ",", "j", ",", "ret", ",", "testOK", ",", "renderedColor", ",", 
        "debugData"}], "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"debugData", "=", 
         RowBox[{"{", "}"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"ret", "=", 
        RowBox[{"<|", 
         RowBox[{
          RowBox[{"\"\<total\>\"", "\[Rule]", "0"}], ",", 
          RowBox[{"\"\<ok\>\"", "\[Rule]", "0"}], ",", 
          RowBox[{"\"\<fail\>\"", "\[Rule]", "0"}], ",", 
          RowBox[{"\"\<black\>\"", "\[Rule]", "0"}]}], "|>"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", 
          RowBox[{"tileMin", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"i", "<", 
          RowBox[{"tileMax", "[", 
           RowBox[{"[", "1", "]"}], "]"}]}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"For", "[", 
           RowBox[{
            RowBox[{"j", "=", 
             RowBox[{"tileMin", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ",", 
            RowBox[{"j", "<", 
             RowBox[{"tileMax", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], ",", 
            RowBox[{"j", "++"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"ret", "[", "\"\<total\>\"", "]"}], "+=", "1"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"testOK", ",", "renderedColor"}], "}"}], "=", 
              RowBox[{"validateOnePixel", "[", 
               RowBox[{"i", ",", "j"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{"testOK", ",", 
               RowBox[{
                RowBox[{"ret", "[", "\"\<ok\>\"", "]"}], "+=", "1"}], ",", 
               RowBox[{
                RowBox[{"ret", "[", "\"\<fail\>\"", "]"}], "+=", "1"}]}], 
              "]"}], ";", "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"!", "testOK"}], ",", 
               RowBox[{
                RowBox[{"ret", "[", "\"\<failedPixel\>\"", "]"}], "=", 
                RowBox[{"{", 
                 RowBox[{"i", ",", "j"}], "}"}]}]}], "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"isBlack", "[", "renderedColor", "]"}], ",", 
               RowBox[{
                RowBox[{"ret", "[", "\"\<black\>\"", "]"}], "+=", "1"}]}], 
              "]"}], ";"}]}], "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"!", 
               RowBox[{"isBlack", "[", "renderedColor", "]"}]}], ",", 
              RowBox[{"Print", "[", 
               RowBox[{"{", 
                RowBox[{"i", ",", "j", ","}], "}"}], "]"}]}], "]"}], "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"(*", 
            RowBox[{
             RowBox[{"AppendTo", "[", 
              RowBox[{"debugData", ",", "testOK"}], "]"}], ";"}], "*)"}], 
           "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
        "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", "ret"}]}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", "debugData", "*)"}], "\[IndentingNewLine]", "]"}]}], ";"}],
   "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"gPrintBounces", "[", "bounces_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "i", "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"i", "=", "1"}], ",", 
         RowBox[{"i", "\[LessEqual]", 
          RowBox[{"Length", "@", "bounces"}]}], ",", 
         RowBox[{"i", "++"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Print", "@", 
           RowBox[{"Style", "[", 
            RowBox[{
             RowBox[{"StringJoin", "[", 
              RowBox[{"\"\<bounce_\>\"", ",", 
               RowBox[{"ToString", "[", 
                RowBox[{"i", "-", "1"}], "]"}]}], "]"}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"FontSize", "\[Rule]", "16"}], ",", 
             RowBox[{"Background", "->", "LightBlue"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Print", "[", 
           RowBox[{"bounces", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"gPrintLogElement", "[", 
     RowBox[{"key_", ",", "msg_"}], "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"key", "\[Equal]", "\"\<bounces\>\""}], ",", 
         RowBox[{
          RowBox[{"gPrintBounces", "[", "msg", "]"}], ";", 
          RowBox[{"Return", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Print", "@", 
         RowBox[{"Style", "[", 
          RowBox[{"key", ",", 
           RowBox[{"FontSize", "\[Rule]", "16"}], ",", 
           RowBox[{"Background", "->", "LightBlue"}]}], "]"}]}], "+", 
        RowBox[{"Print", "[", "msg", "]"}]}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"gPrintLogger", "[", "logger_", "]"}], ":=", 
    RowBox[{"Module", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"gPrintLogElement", "[", 
         RowBox[{"key", ",", 
          RowBox[{"logger", "[", "key", "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"key", ",", 
          RowBox[{"Keys", "[", "logger", "]"}]}], "}"}]}], "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"validatePixels", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"45", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"61", ",", "13"}], "}"}]}], "]"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"validatePixels", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"77", ",", "61"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"93", ",", "77"}], "}"}]}], "]"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"validateOnePixel", "[", 
    RowBox[{"45", ",", "0"}], "]"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"getTestPixelColor", "[", 
    RowBox[{"{", 
     RowBox[{"58", ",", "12"}], "}"}], "]"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"renderPixel", "[", 
      RowBox[{"{", 
       RowBox[{"51", ",", "12"}], "}"}], "]"}], "\[IndentingNewLine]", 
     RowBox[{"gPrintLogger", "[", "currLogger", "]"}]}], ";"}], "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"resultFlag", "=", "False"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"Manipulate", "[", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"Show", "[", "\[IndentingNewLine]", "\t", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{"resultFlag", ",", "\[IndentingNewLine]", 
       RowBox[{"ArrayPlot", "[", 
        RowBox[{"imgTable", ",", 
         RowBox[{"ColorFunctionScaling", "\[Rule]", "False"}]}], "]"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Graphics3D", "[", "graphList", "]"}]}], "]"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Lighting", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"\"\<Ambient\>\"", ",", "White"}], "}"}], "}"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Boxed", "\[Rule]", "False"}], ",", " ", 
     RowBox[{"Axes", "\[Rule]", "False"}], ",", 
     RowBox[{"AxesLabel", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{"\"\<X\>\"", ",", "\"\<Y\>\"", ",", "\"\<Z\>\""}], "}"}]}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{"ViewVector", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{"eyePt", ",", "lookPt"}], "}"}]}], ",", 
     RowBox[{"ViewVertical", "\[Rule]", "upDir"}], ",", 
     RowBox[{"ViewAngle", "\[Rule]", "fov"}]}], "]"}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"Button", "[", 
    RowBox[{"\"\<Result\>\"", ",", 
     RowBox[{"resultFlag", "=", 
      RowBox[{"!", "resultFlag"}]}]}], "]"}], ",", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Button", "[", 
      RowBox[{"\"\<Start\>\"", ",", 
       RowBox[{"testRender", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"77", ",", "61"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"93", ",", "77"}], "}"}], ",", "colorMul"}], "]"}]}], "]"}],
      ","}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{"Button", "[", 
    RowBox[{"\"\<Start\>\"", ",", 
     RowBox[{"testRender", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"45", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"93", ",", "77"}], "}"}], ",", "colorMul"}], "]"}]}], "]"}], 
   ",", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Button", "[", 
      RowBox[{"\"\<Start\>\"", ",", 
       RowBox[{"testRender", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"50", ",", "10"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"98", ",", "80"}], "}"}], ",", "colorMul"}], "]"}]}], "]"}],
      ","}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"colorMul", ",", "10"}], "}"}], ",", "1", ",", "20"}], "}"}]}], 
  "\[IndentingNewLine]", "]"}]}], "Input",
 CellChangeTimes->{{3.837654122022234*^9, 3.8376541560065136`*^9}, {
   3.8376541863354316`*^9, 3.83765418654235*^9}, {3.8376590183229375`*^9, 
   3.837659109872554*^9}, {3.83765937564216*^9, 3.8376593794884515`*^9}, {
   3.8376595373163424`*^9, 3.83765964152796*^9}, {3.83765967686572*^9, 
   3.837659690036155*^9}, {3.837659721289977*^9, 3.837659723736927*^9}, {
   3.8376597651952887`*^9, 3.837659844473301*^9}, {3.837659893449835*^9, 
   3.837660027961242*^9}, {3.8376601136188393`*^9, 3.8376601809844074`*^9}, {
   3.8376644806597033`*^9, 3.837664521170023*^9}, {3.8376801884179153`*^9, 
   3.8376802184893236`*^9}, {3.8377411596379232`*^9, 
   3.8377411606134424`*^9}, {3.8377411911816783`*^9, 3.837741294776919*^9}, {
   3.837741357945646*^9, 3.8377413770301204`*^9}, {3.8377414276525593`*^9, 
   3.837741542348942*^9}, {3.837741675197055*^9, 3.837741790654489*^9}, {
   3.8377418337966876`*^9, 3.83774198147711*^9}, {3.837742011940463*^9, 
   3.8377420488205166`*^9}, {3.837742105698755*^9, 3.8377421439968605`*^9}, {
   3.8377428149393377`*^9, 3.837742820026168*^9}, 3.8377428551311474`*^9, {
   3.8377431779490232`*^9, 3.8377431915878477`*^9}, {3.837743366552213*^9, 
   3.8377434459064655`*^9}, {3.837745412773281*^9, 3.837745437225678*^9}, 
   3.8377457441144023`*^9, {3.837746243728445*^9, 3.837746250311763*^9}, {
   3.8377463513715196`*^9, 3.837746392231592*^9}, {3.837746429135024*^9, 
   3.8377464660089693`*^9}, {3.837746703062667*^9, 3.8377469641453753`*^9}, {
   3.8377470004234433`*^9, 3.837747073105345*^9}, {3.83774729804999*^9, 
   3.837747338150365*^9}, {3.837747506385109*^9, 3.8377476477994967`*^9}, {
   3.837747744222701*^9, 3.8377477633895445`*^9}, {3.8377478567018805`*^9, 
   3.837747856772798*^9}, {3.8377478983527155`*^9, 3.837747935317585*^9}, {
   3.837751929874689*^9, 3.837751937615461*^9}, {3.8377525810007973`*^9, 
   3.8377526303751087`*^9}, {3.8377531196552615`*^9, 3.837753154416168*^9}, {
   3.8377533787178555`*^9, 3.8377535092870703`*^9}, {3.8377535719986815`*^9, 
   3.8377537241677876`*^9}, {3.837753778801285*^9, 3.8377538178323*^9}, {
   3.837753859304861*^9, 3.8377540783924513`*^9}, {3.8377541150245886`*^9, 
   3.8377541168545218`*^9}, {3.8377542952216883`*^9, 3.837754317407643*^9}, {
   3.837754600247965*^9, 3.8377546415329914`*^9}, {3.837754746750693*^9, 
   3.8377547791917524`*^9}, {3.837759759772126*^9, 3.837759829817941*^9}, {
   3.8378092198177643`*^9, 3.8378092737704487`*^9}, {3.8378093277955637`*^9, 
   3.837809403432517*^9}, {3.837809434687477*^9, 3.8378094410722427`*^9}, {
   3.8378095107594147`*^9, 3.8378096401463985`*^9}, {3.837809728480542*^9, 
   3.837809764233906*^9}, {3.837809811936705*^9, 3.837809825472486*^9}, {
   3.837809953201628*^9, 3.83780999703165*^9}, {3.8378104264770436`*^9, 
   3.837810527665268*^9}, {3.837810581193096*^9, 3.837810595984208*^9}, {
   3.8378106809708805`*^9, 3.8378106978772535`*^9}, {3.83781075349125*^9, 
   3.8378107822764206`*^9}, {3.8378108184218016`*^9, 
   3.8378109730123663`*^9}, {3.8378110794444466`*^9, 3.837811112996643*^9}, {
   3.837812607179533*^9, 3.837812750050412*^9}, {3.8378131172980022`*^9, 
   3.837813146633501*^9}, {3.837813215945509*^9, 3.837813246291735*^9}, {
   3.8378133867038665`*^9, 3.8378136493436966`*^9}, {3.8378140861243486`*^9, 
   3.8378142501456337`*^9}, {3.8378142949194827`*^9, 3.837814412581587*^9}, {
   3.837815086025359*^9, 3.8378150862752924`*^9}, {3.8378151255204754`*^9, 
   3.837815162723563*^9}, {3.8378152526646643`*^9, 3.837815408252823*^9}, {
   3.837815482392646*^9, 3.8378154887947454`*^9}, {3.8378245905935497`*^9, 
   3.8378246125843673`*^9}, {3.837824687604117*^9, 3.837824699543831*^9}, {
   3.837824778504441*^9, 3.837824828904827*^9}, {3.8378250361043954`*^9, 
   3.8378252464312477`*^9}, {3.837826415704646*^9, 3.8378264198881407`*^9}, {
   3.8378266001656094`*^9, 3.837826740376923*^9}, {3.8378340608089957`*^9, 
   3.837834167950903*^9}, 3.8378342935267496`*^9, {3.8380676690765886`*^9, 
   3.8380677008025045`*^9}, {3.83806784764771*^9, 3.8380678639088054`*^9}, {
   3.8380678961947403`*^9, 3.838067911237033*^9}, {3.8380679705705166`*^9, 
   3.8380680697489986`*^9}, {3.8380710256552653`*^9, 3.838071037431329*^9}, {
   3.8380711233867064`*^9, 3.8380711292949247`*^9}, {3.8380712117355556`*^9, 
   3.8380712889369354`*^9}, {3.8380713506479645`*^9, 3.838071381052127*^9}, {
   3.8380716725653844`*^9, 3.838071774654976*^9}, {3.838071883216836*^9, 
   3.838071885004939*^9}, {3.838071915245166*^9, 3.8380722902052174`*^9}, {
   3.8380723801021905`*^9, 3.8380723890348043`*^9}, {3.838072423437666*^9, 
   3.8380724582278905`*^9}, {3.8380725812697115`*^9, 
   3.8380728454647245`*^9}, {3.838073183048251*^9, 3.838073195506838*^9}, {
   3.838073254812425*^9, 3.8380732574046497`*^9}, {3.838073322716278*^9, 
   3.8380733746405115`*^9}, {3.838073410894661*^9, 3.838073471689186*^9}, {
   3.8380735043952155`*^9, 3.8380735982527256`*^9}, {3.838073655132366*^9, 
   3.838073665246962*^9}, {3.8380737782040234`*^9, 3.838073909511902*^9}, {
   3.8380739424376574`*^9, 3.8380739440037117`*^9}, {3.8380740512624793`*^9, 
   3.8380741831360393`*^9}, {3.8380742427326508`*^9, 3.838074245556806*^9}, {
   3.8380742797173324`*^9, 3.838074284716983*^9}, {3.838074317531598*^9, 
   3.8380743415413885`*^9}, {3.838074419422126*^9, 3.8380744195499315`*^9}, {
   3.838074450925*^9, 3.8380750306370955`*^9}, {3.8380751325990477`*^9, 
   3.838075139277991*^9}, {3.838085860479731*^9, 3.8380860237454624`*^9}, {
   3.838086083616726*^9, 3.838086105897235*^9}, {3.838086748129386*^9, 
   3.8380867823511143`*^9}, {3.8380868737400494`*^9, 3.838086960478999*^9}, {
   3.8380870311438065`*^9, 3.8380872692642636`*^9}, {3.8380873224302235`*^9, 
   3.838087339996094*^9}, {3.8380873882371225`*^9, 3.8380874510012693`*^9}, {
   3.8380893418565426`*^9, 3.838089596390461*^9}, {3.83808964885468*^9, 
   3.838089703909096*^9}, {3.838089833439418*^9, 3.838089834197732*^9}, {
   3.8380905959618225`*^9, 3.838090600960688*^9}, {3.8380908675208335`*^9, 
   3.838091034565632*^9}, {3.838091076999754*^9, 3.838091098201694*^9}, {
   3.8380911446238737`*^9, 3.8380914867087708`*^9}, {3.838091528004573*^9, 
   3.8380915882250504`*^9}, 3.8380916596357727`*^9, {3.8380918033337755`*^9, 
   3.8380919604260917`*^9}, {3.8380921161296997`*^9, 3.838092180694667*^9}, {
   3.8380923044878674`*^9, 3.8380924380615225`*^9}, {3.83809252110581*^9, 
   3.8380925363910956`*^9}, {3.838092588411086*^9, 3.838092601034545*^9}, {
   3.838092653112667*^9, 3.8380927175169873`*^9}, {3.838092814520995*^9, 
   3.838092825358629*^9}, {3.838093116384361*^9, 3.838093130750067*^9}, {
   3.838093188409277*^9, 3.8380933764743166`*^9}, 3.8380940260732574`*^9, 
   3.838094520874096*^9, {3.838095276718388*^9, 3.8380953014035096`*^9}, {
   3.8380953478469563`*^9, 3.8380955481520357`*^9}, {3.8380958397777524`*^9, 
   3.8380958776953893`*^9}, {3.8380959420276475`*^9, 
   3.8380959870703096`*^9}, {3.838096020206983*^9, 3.8380960486915417`*^9}, {
   3.8380960863133025`*^9, 3.8380961220819693`*^9}, {3.838096474344429*^9, 
   3.838096513710862*^9}, {3.8380966203658147`*^9, 3.838096682351817*^9}, {
   3.8380967219052696`*^9, 3.838096811128806*^9}, {3.8380968479776487`*^9, 
   3.8380969457756615`*^9}, {3.838096991375865*^9, 3.8380970231618567`*^9}, {
   3.8380970702390285`*^9, 3.838097137272153*^9}, {3.838097185842692*^9, 
   3.838097213642475*^9}, {3.8380972447600117`*^9, 3.838097308618882*^9}, {
   3.8380973509756927`*^9, 3.838097626820801*^9}, {3.8380976741709604`*^9, 
   3.838097735176007*^9}, 3.8380977722270794`*^9, {3.838097808139061*^9, 
   3.8380978149853387`*^9}, {3.8380978968225665`*^9, 3.838097909483235*^9}, {
   3.838097991926211*^9, 3.8380980001136637`*^9}, {3.8380980989406157`*^9, 
   3.8380981331471276`*^9}, {3.8380981796299257`*^9, 3.838098205917579*^9}, 
   3.8380983279243193`*^9, {3.838098409409708*^9, 3.838098432814089*^9}, {
   3.838098522383191*^9, 3.838098674210208*^9}, 3.838098704937416*^9, {
   3.838098751950401*^9, 3.838098877298688*^9}, {3.8380989397125587`*^9, 
   3.838098944648754*^9}, {3.8380991321812525`*^9, 3.838099144369*^9}, {
   3.8380992073685913`*^9, 3.8380992326870103`*^9}, 3.8380997225635676`*^9, {
   3.838155236394082*^9, 3.8381552394576097`*^9}, {3.838155291486756*^9, 
   3.8381552959377556`*^9}, {3.838155331713108*^9, 3.838155337290804*^9}, {
   3.8381555891556797`*^9, 3.8381555896404247`*^9}, 3.838155690449917*^9, {
   3.8381557581097593`*^9, 3.838155786390737*^9}, {3.8381574802432594`*^9, 
   3.838157489981015*^9}, {3.8381575637061977`*^9, 3.838157616289229*^9}, {
   3.8381577502904835`*^9, 3.83815775307207*^9}, {3.838157796502204*^9, 
   3.838157966049099*^9}, {3.8381580451288776`*^9, 3.8381580451778374`*^9}, {
   3.838158100420206*^9, 3.8381581411129484`*^9}, {3.838158177717904*^9, 
   3.838158228763075*^9}, {3.8381584490806427`*^9, 3.838158671163499*^9}, {
   3.8381587075200305`*^9, 3.8381588783990717`*^9}, {3.838158912633867*^9, 
   3.8381589513515143`*^9}, {3.8381590227179117`*^9, 3.838159025571518*^9}, {
   3.8381592935902386`*^9, 3.8381593238587103`*^9}, 3.8381593763737917`*^9, {
   3.8381596461556544`*^9, 3.838159729546256*^9}, {3.838159775362418*^9, 
   3.838159846330203*^9}, {3.8381599239782705`*^9, 3.838159942874361*^9}, {
   3.8381599813084507`*^9, 3.838159992076471*^9}, {3.8381603497701235`*^9, 
   3.8381603632342405`*^9}, {3.8381685195169573`*^9, 3.838168574412179*^9}, {
   3.8381686248412695`*^9, 3.8381687719359174`*^9}, {3.8381695807700715`*^9, 
   3.8381696840089846`*^9}, {3.838169738029149*^9, 3.8381698850069513`*^9}, {
   3.8381699252771473`*^9, 3.8381699777446733`*^9}, {3.8381700170171905`*^9, 
   3.83817001916158*^9}, 3.8381700570008802`*^9, {3.838170199030491*^9, 
   3.8381702702852497`*^9}, {3.8381703250455832`*^9, 3.838170354099963*^9}, {
   3.838173258587696*^9, 3.838173889676412*^9}, {3.83817392341169*^9, 
   3.838173962018339*^9}, {3.838174044492138*^9, 3.8381741586218987`*^9}, {
   3.8381742569071817`*^9, 3.8381742921415453`*^9}, {3.8381743367458763`*^9, 
   3.8381743688459935`*^9}, {3.8381744181158*^9, 3.838174464160925*^9}, {
   3.8381747232349005`*^9, 3.838174785509987*^9}, {3.8381748525195527`*^9, 
   3.838174889387686*^9}, {3.838174930063651*^9, 3.83817498142412*^9}, {
   3.8381750254454355`*^9, 3.838175037897682*^9}, {3.838175084205186*^9, 
   3.838175190825652*^9}, {3.8381752935362015`*^9, 3.8381753627722735`*^9}, {
   3.8381754018740563`*^9, 3.8381754019610696`*^9}, {3.8381754895260315`*^9, 
   3.8381754929845333`*^9}, {3.8381758197639236`*^9, 3.83817589681418*^9}, {
   3.8381760435533657`*^9, 3.838176150105022*^9}, {3.8381761818320913`*^9, 
   3.838176237718336*^9}, {3.838178274097228*^9, 3.8381782916260877`*^9}, {
   3.838178358021395*^9, 3.838178377117593*^9}, {3.83817848777837*^9, 
   3.838178577326087*^9}, {3.83817866919074*^9, 3.8381786723399925`*^9}, {
   3.838178722255319*^9, 3.838178750491551*^9}, {3.838178811343565*^9, 
   3.8381788462401266`*^9}, {3.8381788791191845`*^9, 3.838178977645544*^9}, {
   3.838179104605521*^9, 3.8381791109192123`*^9}, {3.838179334508937*^9, 
   3.8381793383831387`*^9}, {3.8381796449271536`*^9, 3.838179697286543*^9}, {
   3.838179732654207*^9, 3.838179785300989*^9}, {3.8381798155652885`*^9, 
   3.838179876301528*^9}, 3.8381800627743855`*^9, {3.838180126061864*^9, 
   3.8381802271258984`*^9}, 3.838180287483613*^9, {3.8381805246768274`*^9, 
   3.838180546924925*^9}, {3.8381806371327205`*^9, 3.838180714549894*^9}, {
   3.8381807526870155`*^9, 3.838180799540453*^9}, {3.838180849450271*^9, 
   3.838180865001443*^9}, {3.8381809355010357`*^9, 3.8381809405943513`*^9}, 
   3.838180980836463*^9, {3.8381810635264826`*^9, 3.838181064414866*^9}, {
   3.838181179428172*^9, 3.838181236151176*^9}, {3.8381813176422095`*^9, 
   3.838181324476951*^9}, {3.838181357117245*^9, 3.838181397550728*^9}, {
   3.8381814298776073`*^9, 3.838181430006581*^9}, {3.838181479289799*^9, 
   3.8381814823790426`*^9}, {3.83818157844394*^9, 3.838181697885736*^9}, {
   3.8381817454819975`*^9, 3.838181768544915*^9}, {3.8381820107723956`*^9, 
   3.8381820431942716`*^9}, {3.838182085845707*^9, 3.8381821485549364`*^9}, {
   3.838182209961011*^9, 3.8381822916262226`*^9}, {3.838182600259403*^9, 
   3.838182607427368*^9}, {3.8381826440653353`*^9, 3.838182718573147*^9}, {
   3.8381827872192073`*^9, 3.8381828155419006`*^9}, {3.838182936561227*^9, 
   3.8381830037255397`*^9}, {3.8381832596972413`*^9, 3.8381832608800297`*^9}, 
   3.8381832925679755`*^9, {3.8381834381258326`*^9, 3.838183449072549*^9}, {
   3.8381834865771947`*^9, 3.838183594303479*^9}, {3.8381836279564247`*^9, 
   3.8381836461250043`*^9}, {3.8381836767166724`*^9, 
   3.8381836768922606`*^9}, {3.838256665277937*^9, 3.838256668347688*^9}, {
   3.838257441515068*^9, 3.838257535140729*^9}, {3.838257764611769*^9, 
   3.8382579425277643`*^9}, {3.8382580105808992`*^9, 3.838258054482294*^9}, {
   3.838258092896356*^9, 3.8382581174888678`*^9}, {3.838258153718953*^9, 
   3.838258194838801*^9}, {3.838258242868476*^9, 3.8382583341199675`*^9}, {
   3.838258503607365*^9, 3.8382585195421185`*^9}, {3.8382586899346275`*^9, 
   3.838258812989023*^9}, {3.8382588432027087`*^9, 3.83825900615652*^9}, {
   3.838259057316549*^9, 3.8382592027087636`*^9}, {3.8382592346824403`*^9, 
   3.8382593276793365`*^9}, {3.8382593727031064`*^9, 3.838259509900882*^9}, {
   3.8382613700103197`*^9, 3.838261414941349*^9}, {3.838261500694125*^9, 
   3.8382615025068183`*^9}, {3.838261538683694*^9, 3.8382615429232054`*^9}, {
   3.8382615884099216`*^9, 3.8382616279702787`*^9}, {3.8382617080804033`*^9, 
   3.838261777794467*^9}, {3.8382618096658373`*^9, 3.838261886630553*^9}, {
   3.8383573527883625`*^9, 3.838357355422884*^9}, {3.838357423486702*^9, 
   3.838357427881879*^9}, {3.8383574627966113`*^9, 3.838357462997828*^9}, {
   3.8383575057245483`*^9, 3.8383575060532875`*^9}, {3.8383575397169204`*^9, 
   3.838357587702512*^9}, {3.838357797868325*^9, 3.8383579313326807`*^9}, {
   3.83835797536397*^9, 3.8383581313113317`*^9}, {3.838358224150941*^9, 
   3.838358290414637*^9}, {3.8383586874751387`*^9, 3.8383587550058165`*^9}, {
   3.8383587870048304`*^9, 3.838358826059868*^9}, 3.838359113833148*^9, {
   3.8383591773122864`*^9, 3.8383591903839893`*^9}, {3.8383592269648685`*^9, 
   3.8383592504398594`*^9}, {3.838359322768787*^9, 3.8383593320507865`*^9}, {
   3.8384124759333963`*^9, 3.838412479652878*^9}, {3.838412511165165*^9, 
   3.838412627814565*^9}, {3.8384126675647097`*^9, 3.838412686390136*^9}, {
   3.8384129849140077`*^9, 3.838413166052352*^9}, {3.8384132849367075`*^9, 
   3.838413289667611*^9}, {3.838413608917898*^9, 3.838413659341488*^9}, {
   3.8384137424518485`*^9, 3.8384137764123034`*^9}, {3.83841388524547*^9, 
   3.838413890811054*^9}, {3.8384197017014456`*^9, 3.8384197487533565`*^9}, {
   3.8384197817205*^9, 3.8384197836160355`*^9}, {3.838419839464077*^9, 
   3.8384198686560683`*^9}, {3.8384199069100657`*^9, 
   3.8384199215098095`*^9}, {3.838419984262805*^9, 3.8384199974470997`*^9}, {
   3.838420029425765*^9, 3.8384200411039786`*^9}, {3.8384201038429394`*^9, 
   3.8384201607993765`*^9}, {3.838420221209176*^9, 3.838420283305377*^9}, {
   3.8384203163548436`*^9, 3.8384203165499754`*^9}, {3.838420388801359*^9, 
   3.8384203933821573`*^9}, {3.838420638647876*^9, 3.8384206669875827`*^9}, {
   3.8384207112155647`*^9, 3.8384207568092613`*^9}, {3.838420796302733*^9, 
   3.8384207969274044`*^9}, {3.8384208306559153`*^9, 3.838420856967107*^9}, {
   3.838429555988446*^9, 3.83842957621553*^9}, {3.838431550800824*^9, 
   3.838431569905053*^9}, {3.838431757229294*^9, 3.8384317639090333`*^9}, {
   3.8384318354084077`*^9, 3.838431851788521*^9}, {3.8384319270330667`*^9, 
   3.8384319577776775`*^9}, {3.838432033657881*^9, 3.838432045476715*^9}, {
   3.838432263144778*^9, 3.838432264308296*^9}, {3.838432323421587*^9, 
   3.8384323441806498`*^9}, {3.8384323757937355`*^9, 
   3.8384324996177464`*^9}, {3.838432654580965*^9, 3.838432753963893*^9}, {
   3.838434051496317*^9, 3.838434074509472*^9}, {3.838434129386935*^9, 
   3.8384341328914213`*^9}, {3.838434164139162*^9, 3.8384342603857956`*^9}, {
   3.838434329125256*^9, 3.8384343409649177`*^9}, {3.8384344058041077`*^9, 
   3.8384346391003375`*^9}, {3.8384346730730767`*^9, 3.838434725890108*^9}, {
   3.838434803658193*^9, 3.8384348646835556`*^9}, {3.838435196627468*^9, 
   3.8384352262508907`*^9}, {3.838435531654235*^9, 3.838435565233037*^9}, {
   3.838435640383745*^9, 3.8384357658373375`*^9}, {3.8384358084839754`*^9, 
   3.8384358101263113`*^9}, {3.8384358576276364`*^9, 3.838435906685177*^9}, {
   3.8384359688113165`*^9, 3.83843599554793*^9}, {3.838436088958726*^9, 
   3.8384360910242734`*^9}, {3.838436147804021*^9, 3.8384361632870803`*^9}, 
   3.8384362067512465`*^9, {3.838436379935102*^9, 3.8384364498404713`*^9}, {
   3.838436490100993*^9, 3.838436516989857*^9}, 3.8384375594866924`*^9, 
   3.8384379655270243`*^9, {3.838438044276743*^9, 3.8384381126730323`*^9}, {
   3.8384381667384877`*^9, 3.838438231694967*^9}, {3.8384387786338353`*^9, 
   3.8384387875443597`*^9}, {3.838439285587145*^9, 3.838439337552886*^9}, {
   3.838439392421299*^9, 3.8384394607669864`*^9}, {3.838439502875619*^9, 
   3.8384395034508977`*^9}, {3.838439536927683*^9, 3.8384396856533947`*^9}, 
   3.838439784126814*^9, {3.838439816659177*^9, 3.8384398971042767`*^9}, {
   3.838440112679384*^9, 3.838440130616947*^9}, {3.838440175319646*^9, 
   3.8384402127566605`*^9}, {3.8384402903078156`*^9, 
   3.8384406259544864`*^9}, {3.838440711948979*^9, 3.8384407667952185`*^9}, {
   3.8384408053806276`*^9, 3.8384408084126344`*^9}, {3.838440861532099*^9, 
   3.838440885553623*^9}, {3.838441062490739*^9, 3.8384410808498545`*^9}, {
   3.8384413072863235`*^9, 3.838441328542022*^9}, {3.8384416722513013`*^9, 
   3.8384418022879553`*^9}, {3.838442509748946*^9, 3.838442560679741*^9}, {
   3.838442603786375*^9, 3.8384426175915775`*^9}, {3.8384438544323134`*^9, 
   3.8384440454229145`*^9}, {3.8384440983217373`*^9, 
   3.8384442027510138`*^9}, {3.8384443005579443`*^9, 
   3.8384443079883833`*^9}, {3.8384443465554266`*^9, 
   3.8384443753884554`*^9}, {3.8384444144328995`*^9, 3.838444491532366*^9}, {
   3.8384445227182674`*^9, 3.838444532461279*^9}, {3.8384445753505545`*^9, 
   3.8384446744427776`*^9}, {3.8384448038063765`*^9, 3.838444830131613*^9}, {
   3.838445170002842*^9, 3.838445239663514*^9}},
 CellLabel->
  "In[26064]:=",ExpressionUUID->"856a8b20-6c6d-4ca2-ada8-1a4ac995cc0c"],

Cell[BoxData[
 TagBox[
  StyleBox[
   DynamicModuleBox[{$CellContext`colorMul$$ = 10, Typeset`show$$ = True, 
    Typeset`bookmarkList$$ = {}, Typeset`bookmarkMode$$ = "Menu", 
    Typeset`animator$$, Typeset`animvar$$ = 1, Typeset`name$$ = 
    "\"untitled\"", Typeset`specs$$ = {{
      Hold[
       Button[
       "Result", $CellContext`resultFlag = Not[$CellContext`resultFlag]]], 
      Manipulate`Dump`ThisIsNotAControl}, {
      Hold[
       Button["Start", 
        $CellContext`testRender[{45, 0}, {93, 77}, $CellContext`colorMul$$]]],
       Manipulate`Dump`ThisIsNotAControl}, {{
       Hold[$CellContext`colorMul$$], 10}, 1, 20}}, Typeset`size$$ = {
    360., {177., 182.}}, Typeset`update$$ = 0, Typeset`initDone$$, 
    Typeset`skipInitDone$$ = True, $CellContext`colorMul$1072788$$ = 0}, 
    DynamicBox[Manipulate`ManipulateBoxes[
     1, StandardForm, "Variables" :> {$CellContext`colorMul$$ = 10}, 
      "ControllerVariables" :> {
        Hold[$CellContext`colorMul$$, $CellContext`colorMul$1072788$$, 0]}, 
      "OtherVariables" :> {
       Typeset`show$$, Typeset`bookmarkList$$, Typeset`bookmarkMode$$, 
        Typeset`animator$$, Typeset`animvar$$, Typeset`name$$, 
        Typeset`specs$$, Typeset`size$$, Typeset`update$$, Typeset`initDone$$,
         Typeset`skipInitDone$$}, "Body" :> Show[
        If[$CellContext`resultFlag, 
         ArrayPlot[$CellContext`imgTable, ColorFunctionScaling -> False], 
         Graphics3D[$CellContext`graphList]], 
        Lighting -> {{"Ambient", White}}, Boxed -> False, Axes -> False, 
        AxesLabel -> {"X", "Y", "Z"}, 
        ViewVector -> {$CellContext`eyePt, $CellContext`lookPt}, 
        ViewVertical -> $CellContext`upDir, ViewAngle -> $CellContext`fov], 
      "Specifications" :> {
        Button[
        "Result", $CellContext`resultFlag = Not[$CellContext`resultFlag]], 
        Button["Start", 
         $CellContext`testRender[{45, 0}, {93, 
          77}, $CellContext`colorMul$$]], {{$CellContext`colorMul$$, 10}, 1, 
         20}}, "Options" :> {}, "DefaultOptions" :> {}],
     ImageSizeCache->{411., {253., 259.}},
     SingleEvaluation->True],
    Deinitialization:>None,
    DynamicModuleValues:>{},
    SynchronousInitialization->True,
    UndoTrackedVariables:>{Typeset`show$$, Typeset`bookmarkMode$$},
    UnsavedVariables:>{Typeset`initDone$$},
    UntrackedVariables:>{Typeset`size$$}], "Manipulate",
   Deployed->True,
   StripOnInput->False],
  Manipulate`InterpretManipulate[1]]], "Output",
 CellChangeTimes->{
  3.8384439293094587`*^9, 3.838443962083754*^9, {3.8384440160319767`*^9, 
   3.838444046426156*^9}, 3.838444109491189*^9, 3.8384441413061347`*^9, {
   3.838444188058525*^9, 3.838444205007554*^9}, {3.8384443239660187`*^9, 
   3.838444377783979*^9}, {3.838444495607266*^9, 3.8384445347696075`*^9}, {
   3.8384445947904453`*^9, 3.83844463826571*^9}, 3.8384446751573606`*^9, {
   3.8384448048364105`*^9, 3.8384448313582287`*^9}, {3.838445173655563*^9, 
   3.8384452405288324`*^9}},
 CellLabel->
  "Out[26140]=",ExpressionUUID->"d57ecfbc-bf25-4d35-802c-91ee5ad73855"]
}, Open  ]]
},
WindowSize->{770, 814},
WindowMargins->{{Automatic, 310}, {32, Automatic}},
FrontEndVersion->"12.0 for Microsoft Windows (64-bit) (April 8, 2019)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 116955, 2762, 14070, "Input",ExpressionUUID->"856a8b20-6c6d-4ca2-ada8-1a4ac995cc0c"],
Cell[117538, 2786, 3074, 61, 531, "Output",ExpressionUUID->"d57ecfbc-bf25-4d35-802c-91ee5ad73855"]
}, Open  ]]
}
]
*)

